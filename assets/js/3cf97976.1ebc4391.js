"use strict";(self.webpackChunkApache_Cloudberry_Incubating_website=self.webpackChunkApache_Cloudberry_Incubating_website||[]).push([[11341],{82210:(e,n,i)=>{i.r(n),i.d(n,{assets:()=>l,contentTitle:()=>o,default:()=>h,frontMatter:()=>r,metadata:()=>a,toc:()=>c});var s=i(85893),t=i(11151);const r={},o="Use PL/Container",a={id:"developer/functions-and-procedures/use-pl-container",title:"Use PL/Container",description:"PL/Container allows you to run procedural language functions inside Docker containers, mitigating the security risks associated with running Python or R code directly on Apache Cloudberry segment hosts. This document introduces the architecture, configuration, usage, and advanced topics of PL/Container.",source:"@site/versioned_docs/version-2.x/developer/functions-and-procedures/use-pl-container.md",sourceDirName:"developer/functions-and-procedures",slug:"/developer/functions-and-procedures/use-pl-container",permalink:"/docs/developer/functions-and-procedures/use-pl-container",draft:!1,unlisted:!1,editUrl:"https://github.com/apache/cloudberry-site/edit/main/versioned_docs/version-2.x/developer/functions-and-procedures/use-pl-container.md",tags:[],version:"2.x",lastUpdatedBy:"TomShawn",lastUpdatedAt:1767860953,formattedLastUpdatedAt:"Jan 8, 2026",frontMatter:{},sidebar:"docsbars",previous:{title:"Stored Procedures and User-Defined Functions",permalink:"/docs/developer/functions-and-procedures/overview"},next:{title:"Use PL/Java",permalink:"/docs/developer/functions-and-procedures/use-pl-java"}},l={},c=[{value:"About the PL/Container language extension",id:"about-the-plcontainer-language-extension",level:2},{value:"PL/Container architecture",id:"plcontainer-architecture",level:3},{value:"Configure and use PL/Container",id:"configure-and-use-plcontainer",level:2},{value:"Prerequisites",id:"prerequisites",level:3},{value:"Step 1: Install Docker",id:"step-1-install-docker",level:3},{value:"Step 2: Enable PL/Container",id:"step-2-enable-plcontainer",level:3},{value:"Step 3: Install and configure Docker images",id:"step-3-install-and-configure-docker-images",level:3},{value:"Step 4: Test the installation",id:"step-4-test-the-installation",level:3},{value:"Write PL/Container functions",id:"write-plcontainer-functions",level:2},{value:"Function definition",id:"function-definition",level:3},{value:"Function examples",id:"function-examples",level:3},{value:"About PL/Python functions",id:"about-plpython-functions",level:3},{value:"PL/Python 2 vs. PL/Python 3",id:"plpython-2-vs-plpython-3",level:4},{value:"Database interaction (<code>plpy</code> module)",id:"database-interaction-plpy-module",level:4},{value:"String quoting",id:"string-quoting",level:4},{value:"Global dictionaries",id:"global-dictionaries",level:4},{value:"About PL/R functions",id:"about-plr-functions",level:3},{value:"Function limitations",id:"function-limitations",level:3},{value:"Manage PL/Container",id:"manage-plcontainer",level:2},{value:"Manage configurations and containers in a session",id:"manage-configurations-and-containers-in-a-session",level:3},{value:"Advanced topics",id:"advanced-topics",level:2},{value:"Resource management",id:"resource-management",level:3},{value:"Configuration process",id:"configuration-process",level:4},{value:"Logging",id:"logging",level:3},{value:"Use CUDA for GPU acceleration",id:"use-cuda-for-gpu-acceleration",level:3},{value:"Prerequisites",id:"prerequisites-1",level:4},{value:"Install and customize the PL/Container image",id:"install-and-customize-the-plcontainer-image",level:4},{value:"Create and run a CUDA function example",id:"create-and-run-a-cuda-function-example",level:4},{value:"Configure remote PL/Container",id:"configure-remote-plcontainer",level:3},{value:"Prerequisites",id:"prerequisites-2",level:4},{value:"Step 1: Configure the remote host",id:"step-1-configure-the-remote-host",level:4},{value:"Step 2: Load the Docker image to the remote host",id:"step-2-load-the-docker-image-to-the-remote-host",level:4},{value:"Step 3: Configure the backend node",id:"step-3-configure-the-backend-node",level:4},{value:"Step 4: Verify the configuration",id:"step-4-verify-the-configuration",level:4},{value:"Notes",id:"notes",level:2}];function d(e){const n={admonition:"admonition",code:"code",h1:"h1",h2:"h2",h3:"h3",h4:"h4",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,t.a)(),...e.components};return(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)(n.h1,{id:"use-plcontainer",children:"Use PL/Container"}),"\n",(0,s.jsx)(n.p,{children:"PL/Container allows you to run procedural language functions inside Docker containers, mitigating the security risks associated with running Python or R code directly on Apache Cloudberry segment hosts. This document introduces the architecture, configuration, usage, and advanced topics of PL/Container."}),"\n",(0,s.jsx)(n.h2,{id:"about-the-plcontainer-language-extension",children:"About the PL/Container language extension"}),"\n",(0,s.jsx)(n.p,{children:"The PL/Container language extension allows you to securely create and run PL/Python or PL/R user-defined functions (UDFs) inside Docker containers. Docker provides the ability to package and run an application in a loosely isolated environment called a container."}),"\n",(0,s.jsx)(n.p,{children:"Running UDFs inside a Docker container ensures that:"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"The function execution occurs in an isolated environment, decoupling data processing."}),"\n",(0,s.jsx)(n.li,{children:"The user code cannot access the host's operating system or file system."}),"\n",(0,s.jsx)(n.li,{children:"The user code does not introduce any security risks."}),"\n",(0,s.jsx)(n.li,{children:"If the container is started with limited or no network access, the function cannot connect back to the database."}),"\n"]}),"\n",(0,s.jsx)(n.h3,{id:"plcontainer-architecture",children:"PL/Container architecture"}),"\n",(0,s.jsx)(n.p,{children:"Example of the process flow:"}),"\n",(0,s.jsxs)(n.ol,{children:["\n",(0,s.jsxs)(n.li,{children:["\n",(0,s.jsx)(n.p,{children:"When a query calls a PL/Container function, the Query Executor (QE) on a segment host starts a container and communicates with it to get results. The container might call back to the database to execute SQL queries via the Server Programming Interface (SPI) and then returns the final results to the QE."}),"\n"]}),"\n",(0,s.jsxs)(n.li,{children:["\n",(0,s.jsx)(n.p,{children:"A container in standby mode waits for a socket connection without consuming any CPU resources. When the Apache Cloudberry database session that started it is closed, the container connection is also closed, and the container shuts down."}),"\n"]}),"\n"]}),"\n",(0,s.jsx)(n.h2,{id:"configure-and-use-plcontainer",children:"Configure and use PL/Container"}),"\n",(0,s.jsx)(n.p,{children:"You do not need to install an extension package to use PL/Container in Apache Cloudberry. You only need to configure the Docker environment and enable the extension in the database."}),"\n",(0,s.jsx)(n.h3,{id:"prerequisites",children:"Prerequisites"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"Docker is installed on all Apache Cloudberry database hosts (coordinator and all segments)."}),"\n",(0,s.jsx)(n.li,{children:"The minimum Linux kernel version is 3.10."}),"\n",(0,s.jsx)(n.li,{children:"The minimum Docker version is 19.03."}),"\n"]}),"\n",(0,s.jsx)(n.h3,{id:"step-1-install-docker",children:"Step 1: Install Docker"}),"\n",(0,s.jsx)(n.p,{children:"You need to install Docker on all Apache Cloudberry database hosts. The following is an installation example on CentOS 7:"}),"\n",(0,s.jsxs)(n.ol,{children:["\n",(0,s.jsxs)(n.li,{children:["\n",(0,s.jsxs)(n.p,{children:["Ensure the current user has ",(0,s.jsx)(n.code,{children:"sudo"})," privileges or is the ",(0,s.jsx)(n.code,{children:"root"})," user."]}),"\n"]}),"\n",(0,s.jsxs)(n.li,{children:["\n",(0,s.jsx)(n.p,{children:"Install the dependencies required for Docker:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-bash",children:"sudo yum install -y yum-utils device-mapper-persistent-data lvm2\n"})}),"\n"]}),"\n",(0,s.jsxs)(n.li,{children:["\n",(0,s.jsx)(n.p,{children:"Add the Docker software repository:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-bash",children:"sudo yum-config-manager --add-repo https://download.docker.com/linux/centos/docker-ce.repo\n"})}),"\n"]}),"\n",(0,s.jsxs)(n.li,{children:["\n",(0,s.jsx)(n.p,{children:"Install Docker:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-bash",children:"sudo yum -y install docker-ce\n"})}),"\n"]}),"\n",(0,s.jsxs)(n.li,{children:["\n",(0,s.jsx)(n.p,{children:"Start the Docker service:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-bash",children:"sudo systemctl start docker\n"})}),"\n"]}),"\n",(0,s.jsxs)(n.li,{children:["\n",(0,s.jsxs)(n.p,{children:["Add the Apache Cloudberry database administrator user (usually ",(0,s.jsx)(n.code,{children:"gpadmin"}),") to the ",(0,s.jsx)(n.code,{children:"docker"})," group so that it can manage Docker images and containers:"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-bash",children:"sudo usermod -aG docker gpadmin\n"})}),"\n"]}),"\n",(0,s.jsxs)(n.li,{children:["\n",(0,s.jsx)(n.p,{children:"Log out of the current session and log back in for the permissions to take effect."}),"\n"]}),"\n",(0,s.jsxs)(n.li,{children:["\n",(0,s.jsx)(n.p,{children:"Configure Docker to start on boot:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-bash",children:"sudo systemctl enable docker.service\n"})}),"\n"]}),"\n",(0,s.jsxs)(n.li,{children:["\n",(0,s.jsx)(n.p,{children:"Test whether Docker is installed successfully. This command lists the currently running containers (which should be empty at this point):"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-bash",children:"docker ps\n"})}),"\n"]}),"\n",(0,s.jsxs)(n.li,{children:["\n",(0,s.jsx)(n.p,{children:"After installing Docker on all hosts, restart the Apache Cloudberry database for the changes to take effect:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-bash",children:"gpstop -ra\n"})}),"\n"]}),"\n"]}),"\n",(0,s.jsx)(n.h3,{id:"step-2-enable-plcontainer",children:"Step 2: Enable PL/Container"}),"\n",(0,s.jsx)(n.p,{children:"PL/Container is a built-in extension in Apache Cloudberry. You only need to run one command in the database where you want to use it to enable it."}),"\n",(0,s.jsxs)(n.ol,{children:["\n",(0,s.jsxs)(n.li,{children:["\n",(0,s.jsxs)(n.p,{children:["Connect to the target database using ",(0,s.jsx)(n.code,{children:"psql"}),":"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-bash",children:"psql -d your_database_name\n"})}),"\n"]}),"\n",(0,s.jsxs)(n.li,{children:["\n",(0,s.jsxs)(n.p,{children:["Run the ",(0,s.jsx)(n.code,{children:"CREATE EXTENSION"})," command:"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-sql",children:"CREATE EXTENSION plcontainer;\n"})}),"\n",(0,s.jsx)(n.p,{children:"After successful execution, PL/Container is activated in that database."}),"\n"]}),"\n"]}),"\n",(0,s.jsx)(n.h3,{id:"step-3-install-and-configure-docker-images",children:"Step 3: Install and configure Docker images"}),"\n",(0,s.jsx)(n.p,{children:"PL/Container requires specific Docker images to create containers for running UDFs."}),"\n",(0,s.jsxs)(n.ol,{children:["\n",(0,s.jsxs)(n.li,{children:["\n",(0,s.jsxs)(n.p,{children:["Obtain the PL/Container Docker image file (for example, ",(0,s.jsx)(n.code,{children:"plcontainer-python3-image-*.tar.gz"}),") from trusted sources."]}),"\n"]}),"\n",(0,s.jsxs)(n.li,{children:["\n",(0,s.jsxs)(n.p,{children:["Use the ",(0,s.jsx)(n.code,{children:"plcontainer image-add"})," command to install the image on all Apache Cloudberry hosts. Use the ",(0,s.jsx)(n.code,{children:"-f"})," option to specify the path to the image file."]}),"\n",(0,s.jsx)(n.admonition,{type:"note",children:(0,s.jsxs)(n.p,{children:["Make sure that your system has the ",(0,s.jsx)(n.code,{children:"rsync"})," dependency; otherwise, the following commands will fail."]})}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-bash",children:"# Installs a Python 3 based Docker image.\nplcontainer image-add -f /path/to/your/plcontainer-python3-image.tar.gz\n\n# Installs an R based Docker image.\nplcontainer image-add -f /path/to/your/plcontainer-r-image.tar.gz\n"})}),"\n"]}),"\n",(0,s.jsxs)(n.li,{children:["\n",(0,s.jsxs)(n.p,{children:["Use the ",(0,s.jsx)(n.code,{children:"plcontainer image-list"})," command to view the installed images:"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-bash",children:"plcontainer image-list\n"})}),"\n"]}),"\n",(0,s.jsxs)(n.li,{children:["\n",(0,s.jsxs)(n.p,{children:["Use the ",(0,s.jsx)(n.code,{children:"plcontainer runtime-add"}),' command to register the installed image as a "runtime" so that it can be called in functions.']}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"-r"}),": Specify the name of the runtime (custom)."]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"-i"}),": Specify the associated Docker image."]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"-l"}),": Specify the language supported by this runtime (",(0,s.jsx)(n.code,{children:"python"}),", ",(0,s.jsx)(n.code,{children:"python3"}),", or ",(0,s.jsx)(n.code,{children:"r"}),")."]}),"\n"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-bash",children:"# Adds a Python 3 runtime.\nplcontainer runtime-add -r plc_python3_shared -i pivotaldata/plcontainer_python3_shared:devel -l python3\n\n# Adds an R runtime.\nplcontainer runtime-add -r plc_r_shared -i pivotaldata/plcontainer_r_shared:devel -l r\n"})}),"\n"]}),"\n"]}),"\n",(0,s.jsx)(n.h3,{id:"step-4-test-the-installation",children:"Step 4: Test the installation"}),"\n",(0,s.jsxs)(n.ol,{children:["\n",(0,s.jsxs)(n.li,{children:["\n",(0,s.jsxs)(n.p,{children:["Connect to the database where PL/Container is enabled using ",(0,s.jsx)(n.code,{children:"psql"}),"."]}),"\n"]}),"\n",(0,s.jsxs)(n.li,{children:["\n",(0,s.jsxs)(n.p,{children:["Create a simple function to test the Python runtime. Note the ",(0,s.jsx)(n.code,{children:"# container:"})," comment, which specifies the runtime ID used by the function."]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-sql",children:"CREATE FUNCTION dummy_python() RETURNS text AS $$\n# container: plc_python3_shared\nreturn 'Hello from Python in a container'\n$$ LANGUAGE plcontainer;\n"})}),"\n"]}),"\n",(0,s.jsxs)(n.li,{children:["\n",(0,s.jsx)(n.p,{children:"Call the function to test it:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-sql",children:"SELECT dummy_python();\n"})}),"\n"]}),"\n",(0,s.jsxs)(n.li,{children:["\n",(0,s.jsx)(n.p,{children:"Similarly, you can create a function to test the R runtime:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-sql",children:"CREATE FUNCTION dummy_r() RETURNS text AS $$\n# container: plc_r_shared\nreturn ('Hello from R in a container')\n$$ LANGUAGE plcontainer;\n"})}),"\n"]}),"\n",(0,s.jsxs)(n.li,{children:["\n",(0,s.jsx)(n.p,{children:"Call the function to perform a test:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-sql",children:"SELECT dummy_r();\n"})}),"\n"]}),"\n"]}),"\n",(0,s.jsx)(n.h2,{id:"write-plcontainer-functions",children:"Write PL/Container functions"}),"\n",(0,s.jsxs)(n.p,{children:["When you enable the PL/Container extension in a database, the ",(0,s.jsx)(n.code,{children:"plcontainer"})," language is registered. You can write functions in PL/Container-supported languages, such as Python or R, by specifying ",(0,s.jsx)(n.code,{children:"LANGUAGE plcontainer"})," in a user-defined function (UDF)."]}),"\n",(0,s.jsxs)(n.p,{children:["The PL/Container configuration file is read only when the first PL/Container function is called in each database session. If you modify the configuration externally, you can force a reload by running ",(0,s.jsx)(n.code,{children:"SELECT * FROM plcontainer_refresh_config;"})," within the session."]}),"\n",(0,s.jsx)(n.h3,{id:"function-definition",children:"Function definition"}),"\n",(0,s.jsx)(n.p,{children:"To create a PL/Container function, the UDF you define must include the following elements:"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Container declaration"}),": The first line of the function body must be ",(0,s.jsx)(n.code,{children:"# container: ID"}),", where ",(0,s.jsx)(n.code,{children:"ID"})," is the runtime ID you defined with ",(0,s.jsx)(n.code,{children:"plcontainer runtime-add"}),"."]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Language declaration"}),": The ",(0,s.jsx)(n.code,{children:"LANGUAGE"})," attribute of the function must be ",(0,s.jsx)(n.code,{children:"plcontainer"}),"."]}),"\n"]}),"\n",(0,s.jsxs)(n.p,{children:["If the ",(0,s.jsx)(n.code,{children:"# container"})," line in a UDF specifies an ID that does not exist in the PL/Container configuration file, the database returns an error when trying to run the UDF."]}),"\n",(0,s.jsx)(n.h3,{id:"function-examples",children:"Function examples"}),"\n",(0,s.jsxs)(n.p,{children:["Here are some basic function examples. Ensure that the ",(0,s.jsx)(n.code,{children:"# container"})," ID in the examples matches the runtime ID you have configured."]}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.strong,{children:"PL/Python example:"})}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-sql",children:"CREATE OR REPLACE FUNCTION pylog100() RETURNS double precision AS $$\n # container: plc_python3_shared\n import math\n return math.log10(100)\n$$ LANGUAGE plcontainer;\n\nSELECT pylog100();\n"})}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.strong,{children:"PL/R example:"})}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-sql",children:"CREATE OR REPLACE FUNCTION rlog100() RETURNS text AS $$\n# container: plc_r_shared\nreturn(log10(100))\n$$ LANGUAGE plcontainer;\n\nSELECT rlog100();\n"})}),"\n",(0,s.jsx)(n.h3,{id:"about-plpython-functions",children:"About PL/Python functions"}),"\n",(0,s.jsx)(n.h4,{id:"plpython-2-vs-plpython-3",children:"PL/Python 2 vs. PL/Python 3"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"PL/Container supports Python 2.7 and Python 3.6+."}),"\n",(0,s.jsx)(n.li,{children:"If you want to use PL/Container to run functions for both Python 2 and Python 3, you need to create two different user-defined functions for them."}),"\n",(0,s.jsx)(n.li,{children:"Note that UDFs written for Python 2 might not run directly in Python 3."}),"\n"]}),"\n",(0,s.jsxs)(n.h4,{id:"database-interaction-plpy-module",children:["Database interaction (",(0,s.jsx)(n.code,{children:"plpy"})," module)"]}),"\n",(0,s.jsxs)(n.p,{children:["The ",(0,s.jsx)(n.code,{children:"plpy"})," module provides a set of methods for interacting with the database:"]}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"plpy.execute(stmt)"}),": Executes a SQL query string and returns the result as a list of dictionaries."]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"plpy.prepare(stmt[, argtypes])"}),": Prepares a query plan."]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"plpy.execute(plan[, argtypes])"}),": Executes a prepared query plan."]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"plpy.debug(msg)"}),", ",(0,s.jsx)(n.code,{children:"plpy.log(msg)"}),", ",(0,s.jsx)(n.code,{children:"plpy.info(msg)"}),", ",(0,s.jsx)(n.code,{children:"plpy.notice(msg)"}),", ",(0,s.jsx)(n.code,{children:"plpy.warning(msg)"}),", ",(0,s.jsx)(n.code,{children:"plpy.error(msg)"}),", ",(0,s.jsx)(n.code,{children:"plpy.fatal(msg)"}),": Sends log messages of different levels to the database logging system. An ",(0,s.jsx)(n.code,{children:"ERROR"})," or ",(0,s.jsx)(n.code,{children:"FATAL"})," level error aborts the transaction."]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"plpy.subtransaction()"}),": Manages explicit subtransactions."]}),"\n"]}),"\n",(0,s.jsx)(n.h4,{id:"string-quoting",children:"String quoting"}),"\n",(0,s.jsxs)(n.p,{children:["The ",(0,s.jsx)(n.code,{children:"plpy"})," module supports several useful string quoting functions for building dynamic queries:"]}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"plpy.quote_literal(string)"}),": Quotes a string as a literal in a SQL statement, correctly handling single quotes and backslashes."]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"plpy.quote_nullable(string)"}),": Same as above, but returns ",(0,s.jsx)(n.code,{children:"NULL"})," if the input is ",(0,s.jsx)(n.code,{children:"null"}),"."]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"plpy.quote_ident(string)"}),": Quotes a string as an identifier in a SQL statement, adding quotes only when necessary."]}),"\n"]}),"\n",(0,s.jsx)(n.h4,{id:"global-dictionaries",children:"Global dictionaries"}),"\n",(0,s.jsxs)(n.p,{children:["The ",(0,s.jsx)(n.code,{children:"plpy"})," module provides two special global dictionaries for persisting data between function calls:"]}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"GD (Global Dictionary)"}),": This dictionary is shared among all function calls within the same container. The data persists as long as the container instance is alive."]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"SD (Static Dictionary)"}),": This dictionary shares data only between multiple calls to the same function."]}),"\n"]}),"\n",(0,s.jsx)(n.admonition,{type:"note",children:(0,s.jsx)(n.p,{children:"Note that the lifecycle of a container is associated with a session. When an idle session is terminated by the database, the related containers are destroyed, and the data in GD and SD will be lost."})}),"\n",(0,s.jsx)(n.h3,{id:"about-plr-functions",children:"About PL/R functions"}),"\n",(0,s.jsxs)(n.p,{children:["The ",(0,s.jsx)(n.code,{children:"pg.spi"})," module in PL/Container provides methods for the R language to interact with the database:"]}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"pg.spi.exec(stmt)"}),": Executes a SQL query and returns an R ",(0,s.jsx)(n.code,{children:"data.frame"}),"."]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"pg.spi.prepare(stmt[, argtypes])"}),": Prepares a query plan."]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"pg.spi.execp(plan[, argtypes])"}),": Executes a prepared query plan."]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"pg.spi.debug(msg)"}),", ",(0,s.jsx)(n.code,{children:"pg.spi.log(msg)"}),", ",(0,s.jsx)(n.code,{children:"pg.spi.info(msg)"}),", ",(0,s.jsx)(n.code,{children:"pg.spi.notice(msg)"}),", ",(0,s.jsx)(n.code,{children:"pg.spi.warning(msg)"}),", ",(0,s.jsx)(n.code,{children:"pg.spi.error(msg)"}),", ",(0,s.jsx)(n.code,{children:"pg.spi.fatal(msg)"}),": Sends log messages of different levels to the database logging system."]}),"\n"]}),"\n",(0,s.jsx)(n.h3,{id:"function-limitations",children:"Function limitations"}),"\n",(0,s.jsx)(n.p,{children:"Note the following limitations when using PL/Container:"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"Database domains are not supported."}),"\n",(0,s.jsx)(n.li,{children:"Multidimensional arrays are not supported."}),"\n",(0,s.jsx)(n.li,{children:"Call stack information for Python and R is not displayed when debugging UDFs."}),"\n",(0,s.jsxs)(n.li,{children:["The ",(0,s.jsx)(n.code,{children:"nrows()"})," and ",(0,s.jsx)(n.code,{children:"status()"})," methods of ",(0,s.jsx)(n.code,{children:"plpy.execute()"})," are not supported."]}),"\n",(0,s.jsxs)(n.li,{children:["The ",(0,s.jsx)(n.code,{children:"plpy.SPIError()"})," method of PL/Python is not supported."]}),"\n",(0,s.jsxs)(n.li,{children:["Running the ",(0,s.jsx)(n.code,{children:"SAVEPOINT"})," command in ",(0,s.jsx)(n.code,{children:"plpy.execute()"})," is not supported."]}),"\n",(0,s.jsx)(n.li,{children:"Container flow control is not supported."}),"\n",(0,s.jsx)(n.li,{children:"Triggers are not supported."}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"OUT"})," parameters are not supported."]}),"\n",(0,s.jsxs)(n.li,{children:["PL/Python functions cannot directly return a Python ",(0,s.jsx)(n.code,{children:"dict"})," type, but it can be converted to a database user-defined type (UDT) before returning."]}),"\n"]}),"\n",(0,s.jsx)(n.h2,{id:"manage-plcontainer",children:"Manage PL/Container"}),"\n",(0,s.jsx)(n.h3,{id:"manage-configurations-and-containers-in-a-session",children:"Manage configurations and containers in a session"}),"\n",(0,s.jsx)(n.p,{children:"PL/Container provides some built-in views and functions to help you view and manage configurations within a database session."}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:["\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"Refresh configuration"}),": If you modify the ",(0,s.jsx)(n.code,{children:"plcontainer_configuration.xml"})," file externally, you can run the following command in a session to force a configuration reload without restarting the database."]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-sql",children:"SELECT * FROM plcontainer_refresh_config;\n"})}),"\n",(0,s.jsx)(n.p,{children:"This command returns the status of the configuration refresh on the coordinator and all segment instances."}),"\n"]}),"\n",(0,s.jsxs)(n.li,{children:["\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"View current configuration"}),":"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-sql",children:"SELECT * FROM plcontainer_show_config;\n"})}),"\n",(0,s.jsx)(n.p,{children:"This command executes a PL/Container function to display configuration information from the coordinator and all segment instances."}),"\n"]}),"\n",(0,s.jsxs)(n.li,{children:["\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"View running containers"}),":"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-sql",children:"SELECT * FROM plcontainer_containers_summary();\n"})}),"\n",(0,s.jsx)(n.p,{children:"If run by a regular user, this function only displays the containers created by that user. If run by a superuser, it displays containers created by all users. The output includes segment ID, container ID, runtime, owner, and memory usage."}),"\n"]}),"\n"]}),"\n",(0,s.jsx)(n.h2,{id:"advanced-topics",children:"Advanced topics"}),"\n",(0,s.jsx)(n.h3,{id:"resource-management",children:"Resource management"}),"\n",(0,s.jsx)(n.p,{children:"Docker containers share CPU and memory resources with the Apache Cloudberry database service on the same host. By default, the database is unaware of the resources consumed by PL/Container instances. You can use the database's resource group feature to control the total CPU resource usage of PL/Container instances."}),"\n",(0,s.jsxs)(n.p,{children:["PL/Container manages resources at two levels: container level and runtime level. You can control container-level CPU and memory resources by configuring ",(0,s.jsx)(n.code,{children:"memory_mb"})," and ",(0,s.jsx)(n.code,{children:"cpu_share"})," settings for a runtime. ",(0,s.jsx)(n.code,{children:"memory_mb"})," controls the memory resources available to each container instance, while ",(0,s.jsx)(n.code,{children:"cpu_share"})," defines the CPU usage weight of a container relative to others."]}),"\n",(0,s.jsx)(n.admonition,{type:"note",children:(0,s.jsx)(n.p,{children:"If you do not explicitly configure a resource group for a PL/Container runtime, its container instances will only be limited by system resources. This can lead to containers consuming excessive resources, thus affecting the performance of the database server."})}),"\n",(0,s.jsx)(n.h4,{id:"configuration-process",children:"Configuration process"}),"\n",(0,s.jsx)(n.p,{children:"To use resource groups to manage PL/Container's CPU resources, you need to explicitly configure both resource groups and PL/Container."}),"\n",(0,s.jsxs)(n.ol,{children:["\n",(0,s.jsxs)(n.li,{children:["\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"Plan resource allocation"}),":"]}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"Analyze the resource usage of your deployment environment to determine the percentage of CPU resources to allocate to PL/Container Docker containers."}),"\n",(0,s.jsx)(n.li,{children:"Decide how to distribute these resources among different PL/Container runtimes. Clarify the required number of resource groups, the CPU percentage for each group, and the mapping between resource groups and runtimes."}),"\n"]}),"\n"]}),"\n",(0,s.jsxs)(n.li,{children:["\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"Create resource groups"}),": Create resource groups according to your plan. For example, assume you decide to allocate 25% of CPU resources to PL/Container and distribute it between two different resource groups in a 60/40 ratio:"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-sql",children:"-- Creates a resource group for the R runtime, allocating 15% CPU.\nCREATE RESOURCE GROUP plr_run1_rg WITH (CONCURRENCY=0, CPU_MAX_PERCENT=15);\n\n-- Creates a resource group for the Python runtime, allocating 10% CPU.\nCREATE RESOURCE GROUP plpy_run1_rg WITH (CONCURRENCY=0, CPU_MAX_PERCENT=10);\n"})}),"\n"]}),"\n",(0,s.jsxs)(n.li,{children:["\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"Get resource group IDs"}),": Query the ",(0,s.jsx)(n.code,{children:"gp_toolkit.gp_resgroup_config"})," view to get the ",(0,s.jsx)(n.code,{children:"groupid"})," of the resource groups you created."]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-sql",children:"SELECT groupname, groupid FROM gp_toolkit.gp_resgroup_config\nWHERE groupname IN ('plpy_run1_rg', 'plr_run1_rg');\n\n-- Example output:\n--  groupname   |  groupid\n-- --------------+----------\n--  plpy_run1_rg |   16391\n--  plr_run1_rg  |   16393\n-- (2 rows)\n"})}),"\n"]}),"\n",(0,s.jsxs)(n.li,{children:["\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"Assign resource groups to runtimes"}),": Use the ",(0,s.jsx)(n.code,{children:"plcontainer runtime-add"})," (for a new runtime) or ",(0,s.jsx)(n.code,{children:"plcontainer runtime-replace"})," (for an existing runtime) command to assign a resource group via the ",(0,s.jsx)(n.code,{children:"-s resource_group_id=<groupid>"})," parameter."]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-bash",children:"# Assigns a resource group to the new python_run1 runtime.\nplcontainer runtime-add -r python_run1 -i pivotaldata/plcontainer_python_shared:devel -l python -s resource_group_id=16391\n\n# Replaces and assigns a resource group to the existing r_run1 runtime.\nplcontainer runtime-replace -r r_run1 -i pivotaldata/plcontainer_r_shared:devel -l r -s resource_group_id=16393\n"})}),"\n",(0,s.jsxs)(n.p,{children:["You can also use the ",(0,s.jsx)(n.code,{children:"plcontainer runtime-edit"})," command to manually edit the configuration file to assign a resource group."]}),"\n"]}),"\n"]}),"\n",(0,s.jsx)(n.p,{children:"After assigning a resource group to a runtime, all container instances that share this runtime configuration will be subject to the CPU limits of that group's configuration. If you delete a PL/Container resource group that is in use, the database will terminate the running containers."}),"\n",(0,s.jsx)(n.h3,{id:"logging",children:"Logging"}),"\n",(0,s.jsxs)(n.p,{children:["When the logging feature of PL/Container is enabled, you can set the log level (default is ",(0,s.jsx)(n.code,{children:"warning"}),") through the database's ",(0,s.jsx)(n.code,{children:"log_min_messages"})," parameter. This parameter controls the log level for both the database and PL/Container."]}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:["\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"Enable logging"}),": PL/Container logging is enabled per runtime ID and controlled by the ",(0,s.jsx)(n.code,{children:"use_container_logging"})," setting, which defaults to no logging."]}),"\n"]}),"\n",(0,s.jsxs)(n.li,{children:["\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"Log content and location"}),": PL/Container log messages originate from UDFs running in Docker containers. On Red Hat 8 systems, log messages are sent to the ",(0,s.jsx)(n.code,{children:"journald"})," service by default. Database log messages are sent to the log files on the coordinator node."]}),"\n"]}),"\n",(0,s.jsxs)(n.li,{children:["\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"Dynamically adjust log level"}),": When testing or troubleshooting, you can use the ",(0,s.jsx)(n.code,{children:"SET"})," command in a session to temporarily change the log level, for example, to ",(0,s.jsx)(n.code,{children:"debug1"}),"."]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-sql",children:"SET log_min_messages='debug1';\n"})}),"\n"]}),"\n"]}),"\n",(0,s.jsx)(n.admonition,{type:"note",children:(0,s.jsxs)(n.p,{children:["The ",(0,s.jsx)(n.code,{children:"log_min_messages"})," parameter affects logging for both the database and PL/Container. Increasing the log level might affect database performance, even if no PL/Container functions are running."]})}),"\n",(0,s.jsx)(n.h3,{id:"use-cuda-for-gpu-acceleration",children:"Use CUDA for GPU acceleration"}),"\n",(0,s.jsx)(n.p,{children:"PL/Container supports using NVIDIA GPUs for computational acceleration. This requires you to prepare a custom Docker image containing the CUDA Toolkit and corresponding Python libraries (such as PyCUDA) and configure it accordingly."}),"\n",(0,s.jsx)(n.h4,{id:"prerequisites-1",children:"Prerequisites"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"Docker engine version is not lower than v19.03."}),"\n",(0,s.jsx)(n.li,{children:"PL/Container version is not lower than 2.2.0."}),"\n",(0,s.jsx)(n.li,{children:"At least one NVIDIA GPU is on the host, and the corresponding GPU driver is installed."}),"\n",(0,s.jsxs)(n.li,{children:["NVIDIA Container Toolkit is installed, and it is verified that the ",(0,s.jsx)(n.code,{children:"nvidia-docker"})," image can successfully use the GPU."]}),"\n"]}),"\n",(0,s.jsx)(n.h4,{id:"install-and-customize-the-plcontainer-image",children:"Install and customize the PL/Container image"}),"\n",(0,s.jsxs)(n.ol,{children:["\n",(0,s.jsxs)(n.li,{children:["\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"Load the base image"}),": Obtain the PL/Container Python 3 image from official channels and load it into Docker."]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-bash",children:"docker image load < plcontainer-python3-image-*.tar.gz\n"})}),"\n"]}),"\n",(0,s.jsxs)(n.li,{children:["\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"Customize the image"}),": Create a Dockerfile to add the CUDA runtime and the ",(0,s.jsx)(n.code,{children:"pycuda"})," library to the base image. The following is an example Dockerfile content for adding CUDA 11.7 and ",(0,s.jsx)(n.code,{children:"pycuda"})," 2021.1:"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-dockerfile",children:'FROM pivotaldata/plcontainer_python3_shared:devel\n\nENV XKBLAYOUT=en\nENV DEBIAN_FRONTEND=noninteractive\n\n# Install CUDA from https://developer.nvidia.com/cuda-downloads\n# By downloading and using the software, you agree to fully comply with the terms and conditions of the CUDA EULA.\nRUN true &&\\\n    wget https://developer.download.nvidia.com/compute/cuda/repos/ubuntu1804/x86_64/cuda-ubuntu2204.pin && \\\n    mv cuda-ubuntu1804.pin /etc/apt/preferences.d/cuda-repository-pin-600 && \\\n    wget https://developer.download.nvidia.com/compute/cuda/11.7.0/local_installers/cuda-repo-ubuntu1804-11-7-local_11.7.0-515.43.04-1_amd64.deb && \\\n    dpkg -i cuda-repo-ubuntu1804-11-7-local_11.7.0-515.43.04-1_amd64.deb && \\\n    cp /var/cuda-repo-ubuntu1804-11-7-local/cuda-*-keyring.gpg /usr/share/keyrings/ && \\\n    apt-get update && \\\n    apt-get -y install cuda && \\\n    rm cuda-repo-ubuntu1804-11-7-local_11.7.0-515.43.04-1_amd64.deb &&\\\n    rm -rf /var/lib/apt/lists/*\n\nENV PATH="/usr/local/cuda-11.7/bin/:${PATH}"\nENV LD_LIBRARY_PATH="/usr/local/cuda-11.7/lib64:${LD_LIBRARY_PATH:+:${LD_LIBRARY_PATH}}"\nENV CUDA_HOME="/usr/local/cuda-11.7"\n\nRUN true && \\\n    python3.7 -m pip --no-cache-dir install typing-extensions==3.10.0.0 && \\\n    python3.7 -m pip --no-cache-dir install Mako==1.2.0 && \\\n    python3.7 -m pip --no-cache-dir install platformdirs==2.5.2 && \\\n    python3.7 -m pip --no-cache-dir install pytools==2022.1.2 && \\\n    python3.7 -m pip --no-cache-dir install pycuda==2021.1\n'})}),"\n"]}),"\n",(0,s.jsxs)(n.li,{children:["\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"Build the custom image"}),":"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-bash",children:"docker build . -t localhost/plcontainer_python3_cuda_shared:latest\n"})}),"\n"]}),"\n",(0,s.jsxs)(n.li,{children:["\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"Add and configure the runtime"}),":"]}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:["\n",(0,s.jsx)(n.p,{children:"Add a new runtime and associate it with the image you just built."}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-bash",children:"plcontainer runtime-add -r plc_python_cuda_shared -I localhost/plcontainer_python3_cuda_shared:latest -l python3\n"})}),"\n"]}),"\n",(0,s.jsxs)(n.li,{children:["\n",(0,s.jsx)(n.p,{children:"Edit the runtime configuration to assign a GPU device to it."}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-bash",children:"plcontainer runtime-edit\n"})}),"\n",(0,s.jsxs)(n.p,{children:["In the XML configuration, add a ",(0,s.jsx)(n.code,{children:"<device_request>"})," section for this runtime."]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-xml",children:'<runtime>\n    <id>plc_python_cuda_shared</id>\n    <image>localhost/plcontainer_python3_cuda_shared:latest</image>\n    ...\n    <device_request type="gpu">\n        <deviceid>0</deviceid> \x3c!-- Specifies the ID of the GPU device. --\x3e\n    </device_request>\n</runtime>\n'})}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,s.jsx)(n.h4,{id:"create-and-run-a-cuda-function-example",children:"Create and run a CUDA function example"}),"\n",(0,s.jsxs)(n.ol,{children:["\n",(0,s.jsxs)(n.li,{children:["\n",(0,s.jsx)(n.p,{children:"Connect to the database and create a function that uses the CUDA runtime."}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-sql",children:'CREATE FUNCTION hello_cuda() RETURNS float4[] AS $$\n# container: plc_python_cuda_shared\n\nimport pycuda.driver as drv\nimport pycuda.tools\nimport pycuda.autoinit\nimport numpy\nimport numpy.linalg as la\nfrom pycuda.compiler import SourceModule\n\nmod = SourceModule("""\n__global__ void multiply_them(float *dest, float *a, float *b)\n{\n  const int i = threadIdx.x;\n  dest[i] = a[i] * b[i];\n}\n""")\n\nmultiply_them = mod.get_function("multiply_them")\n  \na = numpy.random.randn(400).astype(numpy.float32)\nb = numpy.random.randn(400).astype(numpy.float32)\n\ndest = numpy.zeros_like(a)\nmultiply_them(\n        drv.Out(dest), drv.In(a), drv.In(b),\n        block=(400,1,1))\n  \nreturn [float(i) for i in (dest-a*b)]\n\n$$ LANGUAGE plcontainer;\n'})}),"\n"]}),"\n",(0,s.jsxs)(n.li,{children:["\n",(0,s.jsx)(n.p,{children:"Execute the function and verify the result."}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-sql",children:"-- Calculates the sum of the resulting array, which is expected to be 0.0.\nWITH a AS (SELECT unnest(hello) AS cuda FROM hello_cuda() AS hello) SELECT sum(cuda) FROM a;\n"})}),"\n"]}),"\n"]}),"\n",(0,s.jsx)(n.h3,{id:"configure-remote-plcontainer",children:"Configure remote PL/Container"}),"\n",(0,s.jsx)(n.p,{children:"You can configure one or more remote hosts outside the cluster to execute PL/Container workloads, thereby reducing the computational overhead on database hosts."}),"\n",(0,s.jsx)(n.h4,{id:"prerequisites-2",children:"Prerequisites"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"PL/Container version is not lower than 2.4.0."}),"\n",(0,s.jsxs)(n.li,{children:["Docker engine (version not lower than v19.03) is installed on the remote host, and you have ",(0,s.jsx)(n.code,{children:"root"})," or ",(0,s.jsx)(n.code,{children:"sudo"})," permissions."]}),"\n"]}),"\n",(0,s.jsx)(n.h4,{id:"step-1-configure-the-remote-host",children:"Step 1: Configure the remote host"}),"\n",(0,s.jsxs)(n.ol,{children:["\n",(0,s.jsxs)(n.li,{children:["\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"Install Docker"}),": Install Docker on the remote host."]}),"\n"]}),"\n",(0,s.jsxs)(n.li,{children:["\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"Enable remote API"}),": Edit Docker's service file to make it listen on a TCP port (for example, 2375)."]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-bash",children:"sudo systemctl edit docker.service\n\n# Adds the following content to the beginning of the file:\n[Service]\nExecStart=\nExecStart=/usr/bin/dockerd -H fd:// -H tcp://0.0.0.0:2375\n\n# Restarts the Docker service.\nsudo systemctl restart docker\n"})}),"\n"]}),"\n",(0,s.jsxs)(n.li,{children:["\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"Prepare the remote environment"}),": Ensure that the ",(0,s.jsx)(n.code,{children:"gpadmin"})," user, passwordless SSH access, ",(0,s.jsx)(n.code,{children:"python3"}),", and ",(0,s.jsx)(n.code,{children:"rsync"})," are installed on the remote host. Then, perform the remote setup from the coordinator node."]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-bash",children:'# Creates a directory on the remote host.\nssh gpadmin@<remoteip> "sudo mkdir $GPHOME && sudo chown gpadmin:gpadmin $GPHOME"\n\n# Copies the plcontainer client from the coordinator to the remote host (multiple hosts can be specified).\nplcontainer remote-setup --hosts <remoteip_1>,<remoteip_2>\n'})}),"\n"]}),"\n"]}),"\n",(0,s.jsx)(n.h4,{id:"step-2-load-the-docker-image-to-the-remote-host",children:"Step 2: Load the Docker image to the remote host"}),"\n",(0,s.jsx)(n.p,{children:"From the coordinator node, load the required Docker image onto one or more remote hosts."}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-bash",children:"plcontainer image-add --hosts <remoteip_1>,<remoteip_2> -f <image_file>\n"})}),"\n",(0,s.jsx)(n.h4,{id:"step-3-configure-the-backend-node",children:"Step 3: Configure the backend node"}),"\n",(0,s.jsxs)(n.ol,{children:["\n",(0,s.jsxs)(n.li,{children:["\n",(0,s.jsx)(n.p,{children:"On the coordinator node, edit the PL/Container configuration file."}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-bash",children:"plcontainer runtime-edit\n"})}),"\n"]}),"\n",(0,s.jsxs)(n.li,{children:["\n",(0,s.jsxs)(n.p,{children:["In the XML file, add a new ",(0,s.jsx)(n.code,{children:"<backend>"})," section to define the remote host cluster. Then, modify the existing ",(0,s.jsx)(n.code,{children:"<runtime>"})," section to use this newly defined backend via ",(0,s.jsx)(n.code,{children:'<backend name="..."/>'}),"."]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-xml",children:'<?xml version="1.0" ?>\n<configuration>\n    <backend name="calculate_cluster" type="remote_docker">\n        <address>REMOTE_HOST_IP</address>\n        <port>2375</port>\n    </backend>\n    <runtime>\n        <id>plc_python_remote</id>\n        <image>your_image:tag</image>\n        <command>/clientdir/py3client.sh</command>\n        <shared_directory access="ro" container="/clientdir" host="/usr/local/greenplum-db/bin/plcontainer_clients"/>\n        <backend name="calculate_cluster" />\n        <setting enable_network="yes" roles="gpadmin" />\n    </runtime>\n</configuration>\n'})}),"\n",(0,s.jsx)(n.p,{children:"If you have multiple remote hosts, you need to create different backend and runtime configurations for them."}),"\n"]}),"\n"]}),"\n",(0,s.jsx)(n.h4,{id:"step-4-verify-the-configuration",children:"Step 4: Verify the configuration"}),"\n",(0,s.jsx)(n.p,{children:"Create a function that uses the remote runtime and execute it. If it succeeds, it means the function has run on the remote host."}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-sql",children:"CREATE FUNCTION dummy_remote_python() RETURNS text AS $$\n# container: plc_python_remote\nreturn 'hello from a remote Python container'\n$$ LANGUAGE plcontainer;\n\nSELECT * from dummy_remote_python();\n"})}),"\n",(0,s.jsx)(n.h2,{id:"notes",children:"Notes"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"If a PL/Container Docker container exceeds the allowed maximum memory, it will be terminated with an out-of-memory warning."}),"\n",(0,s.jsxs)(n.li,{children:["PL/Container does not limit the base device size of Docker containers. In some cases, the Docker daemon controls this size. For example, if the Docker storage driver is ",(0,s.jsx)(n.code,{children:"devicemapper"}),", its base size defaults to 10GB. You can use the ",(0,s.jsx)(n.code,{children:"docker info"})," command to view the storage driver and related configurations."]}),"\n",(0,s.jsxs)(n.li,{children:["When a PL/Container UDF is executed, the Query Executor (QE) process starts and reuses Docker containers as needed. After being idle for a period, the QE process exits and destroys its Docker containers. You can control this idle time through the ",(0,s.jsx)(n.code,{children:"gp_vmem_idle_resource_timeout"})," parameter, thereby affecting the container reuse policy. However, note that modifying this parameter also affects the recycling of other database resources, which might impact performance."]}),"\n"]})]})}function h(e={}){const{wrapper:n}={...(0,t.a)(),...e.components};return n?(0,s.jsx)(n,{...e,children:(0,s.jsx)(d,{...e})}):d(e)}},11151:(e,n,i)=>{i.d(n,{Z:()=>a,a:()=>o});var s=i(67294);const t={},r=s.createContext(t);function o(e){const n=s.useContext(r);return s.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function a(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(t):e.components||t:o(e.components),s.createElement(r.Provider,{value:n},e.children)}}}]);