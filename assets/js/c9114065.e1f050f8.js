"use strict";(self.webpackChunkApache_Cloudberry_Incubating_website=self.webpackChunkApache_Cloudberry_Incubating_website||[]).push([[50004],{59931:(e,n,r)=>{r.r(n),r.d(n,{assets:()=>c,contentTitle:()=>t,default:()=>h,frontMatter:()=>o,metadata:()=>l,toc:()=>a});var s=r(85893),i=r(11151);const o={title:"Recover from Segment Failures"},t="Recover from Segment Failures",l={id:"sys-admin/high-availability/recover-from-segment-failures",title:"Recover from Segment Failures",description:"This topic walks you through what to do when one or more segments or hosts are down and you want to recover the down segments. The recovery path you follow depends primarily which of these 3 scenarios fits your circumstances:",source:"@site/docs/sys-admin/high-availability/recover-from-segment-failures.md",sourceDirName:"sys-admin/high-availability",slug:"/sys-admin/high-availability/recover-from-segment-failures",permalink:"/docs/next/sys-admin/high-availability/recover-from-segment-failures",draft:!1,unlisted:!1,editUrl:"https://github.com/apache/cloudberry-site/edit/main/docs/sys-admin/high-availability/recover-from-segment-failures.md",tags:[],version:"current",lastUpdatedBy:"Dianjin Wang",lastUpdatedAt:1766576493,formattedLastUpdatedAt:"Dec 24, 2025",frontMatter:{title:"Recover from Segment Failures"},sidebar:"docsbars",previous:{title:"Check for Failed Segments",permalink:"/docs/next/sys-admin/high-availability/check-for-failed-segments"},next:{title:"Recover a Failed Coordinator",permalink:"/docs/next/sys-admin/high-availability/recover-a-failed-coordinator"}},c={},a=[{value:"Prerequisites",id:"prerequisites",level:2},{value:"Recovery scenarios",id:"recovery-scenarios",level:2},{value:"Recover in-place to current host",id:"recover-in-place-to-current-host",level:3},{value:"Incremental recovery",id:"incremental-recovery",level:4},{value:"Full recovery",id:"full-recovery",level:4},{value:"Differential recovery",id:"differential-recovery",level:4},{value:"Recover to a different host within the cluster",id:"recover-to-a-different-host-within-the-cluster",level:3},{value:"Recover to a new host, outside of the cluster",id:"recover-to-a-new-host-outside-of-the-cluster",level:3},{value:"Requirements for new host",id:"requirements-for-new-host",level:4},{value:"Steps to recover to a new host",id:"steps-to-recover-to-a-new-host",level:4},{value:"Post-recovery tasks",id:"post-recovery-tasks",level:3}];function d(e){const n={a:"a",admonition:"admonition",code:"code",h1:"h1",h2:"h2",h3:"h3",h4:"h4",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,i.a)(),...e.components};return(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)(n.h1,{id:"recover-from-segment-failures",children:"Recover from Segment Failures"}),"\n",(0,s.jsx)(n.p,{children:"This topic walks you through what to do when one or more segments or hosts are down and you want to recover the down segments. The recovery path you follow depends primarily which of these 3 scenarios fits your circumstances:"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:["\n",(0,s.jsx)(n.p,{children:"you want to recover in-place to the current host"}),"\n"]}),"\n",(0,s.jsxs)(n.li,{children:["\n",(0,s.jsx)(n.p,{children:"you want to recover to a different host, within the cluster"}),"\n"]}),"\n",(0,s.jsxs)(n.li,{children:["\n",(0,s.jsx)(n.p,{children:"you want to recover to a new host, outside of the cluster"}),"\n"]}),"\n"]}),"\n",(0,s.jsx)(n.p,{children:"The steps you follow within these scenarios can vary, depending on:"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:["\n",(0,s.jsx)(n.p,{children:"whether you want to do an incremental or a full recovery"}),"\n"]}),"\n",(0,s.jsxs)(n.li,{children:["\n",(0,s.jsx)(n.p,{children:"whether you want to recover all segments or just a subset of segments"}),"\n"]}),"\n"]}),"\n",(0,s.jsx)(n.admonition,{type:"note",children:(0,s.jsx)(n.p,{children:"Incremental recovery is only possible when recovering segments to the current host (in-place recovery)."})}),"\n",(0,s.jsx)(n.p,{children:"This topic is divided into the following sections:"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:(0,s.jsx)(n.a,{href:"#prerequisites",children:"Prerequisites"})}),"\n",(0,s.jsx)(n.li,{children:(0,s.jsx)(n.a,{href:"#recovery-scenarios",children:"Recovery Scenarios"})}),"\n",(0,s.jsx)(n.li,{children:(0,s.jsx)(n.a,{href:"#post-recovery-tasks",children:"Post-Recovery Tasks"})}),"\n"]}),"\n",(0,s.jsx)(n.h2,{id:"prerequisites",children:"Prerequisites"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"Mirroring is enabled for all segments."}),"\n",(0,s.jsxs)(n.li,{children:["You've already identified which segments have failed. If necessary, see the topic ",(0,s.jsx)(n.a,{href:"/docs/next/sys-admin/high-availability/check-for-failed-segments",children:"Checking for Failed Segments"}),"."]}),"\n",(0,s.jsx)(n.li,{children:"The coordinator host can connect to the segment host."}),"\n",(0,s.jsx)(n.li,{children:"All networking or hardware issues that caused the segment to fail have been resolved."}),"\n"]}),"\n",(0,s.jsx)(n.h2,{id:"recovery-scenarios",children:"Recovery scenarios"}),"\n",(0,s.jsx)(n.p,{children:"This section documents the steps for the 3 distinct segment recovery scenarios. Follow the link to instructions that walk you through each scenario."}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.a,{href:"#recover-in-place-to-current-host",children:"Recover In-Place to Current Host"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:(0,s.jsx)(n.a,{href:"#incremental-recovery",children:"Incremental Recovery"})}),"\n",(0,s.jsx)(n.li,{children:(0,s.jsx)(n.a,{href:"#full-recovery",children:"Full Recovery"})}),"\n",(0,s.jsx)(n.li,{children:(0,s.jsx)(n.a,{href:"#differential-recovery",children:"Differential Recovery"})}),"\n"]}),"\n"]}),"\n",(0,s.jsx)(n.li,{children:(0,s.jsx)(n.a,{href:"#recover-to-a-different-host-within-the-cluster",children:"Recover to A Different Host within the Cluster"})}),"\n",(0,s.jsx)(n.li,{children:(0,s.jsx)(n.a,{href:"#recover-to-a-different-host-within-the-cluster",children:"Recover to A New Host, Outside of the Cluster"})}),"\n"]}),"\n",(0,s.jsx)(n.h3,{id:"recover-in-place-to-current-host",children:"Recover in-place to current host"}),"\n",(0,s.jsx)(n.p,{children:"When recovering in-place to the current host, you may choose between incremental recovery (the default), full recovery, and differential recovery."}),"\n",(0,s.jsx)(n.h4,{id:"incremental-recovery",children:"Incremental recovery"}),"\n",(0,s.jsx)(n.p,{children:"Follow these steps for incremental recovery:"}),"\n",(0,s.jsxs)(n.ol,{children:["\n",(0,s.jsxs)(n.li,{children:["\n",(0,s.jsxs)(n.p,{children:["To recover all segments, run ",(0,s.jsx)(n.code,{children:"gprecoverseg"})," with no options:"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-shell",children:"gprecoverseg\n"})}),"\n"]}),"\n",(0,s.jsxs)(n.li,{children:["\n",(0,s.jsx)(n.p,{children:"To recover a subset of segments:"}),"\n",(0,s.jsxs)(n.ol,{children:["\n",(0,s.jsxs)(n.li,{children:["\n",(0,s.jsxs)(n.p,{children:["Manually create a ",(0,s.jsx)(n.code,{children:"recover_config_file"})," file in a location of your choice, where each segment to recover has its own line with format ",(0,s.jsx)(n.code,{children:"failedAddress|failedPort|failedDataDirectory"})," or ",(0,s.jsx)(n.code,{children:"failedHostname|failedAddress|failedPort|failedDataDirectory"})]}),"\n",(0,s.jsx)(n.p,{children:"For multiple segments, create a new line for each segment you want to recover, specifying the hostname (optional), the address, port number and data directory for each down segment. For example:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{children:"failedAddress1|failedPort1|failedDataDirectory1\nfailedAddress2|failedPort2|failedDataDirectory2\nfailedAddress3|failedPort3|failedDataDirectory3\n"})}),"\n",(0,s.jsx)(n.p,{children:"or"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{children:"failedHostname1|failedAddress1|failedPort1|failedDataDirectory1\nfailedHostname2|failedAddress2|failedPort2|failedDataDirectory2\nfailedHostname3|failedAddress3|failedPort3|failedDataDirectory3\n"})}),"\n"]}),"\n",(0,s.jsxs)(n.li,{children:["\n",(0,s.jsx)(n.p,{children:"Alternatively, generate a sample recovery file using the following command; you may edit the resulting file if necessary:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-shell",children:"$ gprecoverseg -o /home/gpadmin/recover_config_file\n"})}),"\n"]}),"\n",(0,s.jsxs)(n.li,{children:["\n",(0,s.jsxs)(n.p,{children:["Pass the ",(0,s.jsx)(n.code,{children:"recover_config_file"})," to the ",(0,s.jsx)(n.code,{children:"gprecoverseg -i"})," command:"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-shell",children:"$ gprecoverseg -i /home/gpadmin/recover_config_file  \n"})}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,s.jsxs)(n.li,{children:["\n",(0,s.jsxs)(n.p,{children:["Perform the post-recovery tasks summarized in the section ",(0,s.jsx)(n.a,{href:"#post-recovery-tasks",children:"Post-Recovery Tasks"}),"."]}),"\n"]}),"\n"]}),"\n",(0,s.jsx)(n.h4,{id:"full-recovery",children:"Full recovery"}),"\n",(0,s.jsxs)(n.ol,{children:["\n",(0,s.jsxs)(n.li,{children:["\n",(0,s.jsxs)(n.p,{children:["To recover all segments, run ",(0,s.jsx)(n.code,{children:"gprecoverseg -F"}),":"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-shell",children:"gprecoverseg -F\n"})}),"\n"]}),"\n",(0,s.jsxs)(n.li,{children:["\n",(0,s.jsx)(n.p,{children:"To recover specific segments:"}),"\n",(0,s.jsxs)(n.ol,{children:["\n",(0,s.jsxs)(n.li,{children:["\n",(0,s.jsxs)(n.p,{children:["Manually create a ",(0,s.jsx)(n.code,{children:"recover_config_file"})," file in a location of your choice, where each segment to recover has its own line with following format:"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{children:"failedAddress1|failedPort1|failedDataDirectory1<SPACE>failedAddress2|failedPort2|failedDataDirectory2\n"})}),"\n",(0,s.jsx)(n.p,{children:"or"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{children:"failedHostname1|failedAddress1|failedPort1|failedDataDirectory1<SPACE>failedHostname2|failedAddress2|failedPort2|failedDataDirectory2\n"})}),"\n",(0,s.jsxs)(n.p,{children:["Note the literal ",(0,s.jsx)(n.strong,{children:"SPACE"})," separating the lines."]}),"\n"]}),"\n",(0,s.jsxs)(n.li,{children:["\n",(0,s.jsx)(n.p,{children:"Alternatively, generate a sample recovery file using the following command and edit the resulting file to match your desired recovery configuration:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-shell",children:"$ gprecoverseg -o /home/gpadmin/recover_config_file\n"})}),"\n"]}),"\n",(0,s.jsxs)(n.li,{children:["\n",(0,s.jsx)(n.p,{children:"Run the following command, passing in the config file generated in the previous step:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-shell",children:"$ gprecoverseg -i recover_config_file\n"})}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,s.jsxs)(n.li,{children:["\n",(0,s.jsxs)(n.p,{children:["Perform the post-recovery tasks summarized in the section ",(0,s.jsx)(n.a,{href:"#post-recovery-tasks",children:"Post-Recovery Tasks"}),"."]}),"\n"]}),"\n"]}),"\n",(0,s.jsx)(n.h4,{id:"differential-recovery",children:"Differential recovery"}),"\n",(0,s.jsx)(n.p,{children:"Follow these steps for differential recovery:"}),"\n",(0,s.jsxs)(n.ol,{children:["\n",(0,s.jsxs)(n.li,{children:["Run ",(0,s.jsx)(n.code,{children:"gprecoverseg --differential"})]}),"\n"]}),"\n",(0,s.jsx)(n.h3,{id:"recover-to-a-different-host-within-the-cluster",children:"Recover to a different host within the cluster"}),"\n",(0,s.jsx)(n.admonition,{type:"note",children:(0,s.jsx)(n.p,{children:"Only full recovery is possible when recovering to a different host in the cluster."})}),"\n",(0,s.jsx)(n.p,{children:"Follow these steps to recover all segments or just a subset of segments to a different host in the cluster:"}),"\n",(0,s.jsxs)(n.ol,{children:["\n",(0,s.jsxs)(n.li,{children:["\n",(0,s.jsxs)(n.p,{children:["Manually create a ",(0,s.jsx)(n.code,{children:"recover_config_file"})," file in a location of your choice, where each segment to recover has its own line with following format:"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{children:"failedAddress|failedPort|failedDataDirectory<SPACE>newAddress|newPort|newDataDirectory\n"})}),"\n",(0,s.jsx)(n.p,{children:"or"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{children:"failedHostname|failedAddress|failedPort|failedDataDirectory<SPACE>newHostname|newAddress|newPort|newDataDirectory\n"})}),"\n",(0,s.jsxs)(n.p,{children:["Note the literal ",(0,s.jsx)(n.strong,{children:"SPACE"})," separating the details of the down segment from the details of where the segment will be recovered to."]}),"\n",(0,s.jsx)(n.p,{children:"Alternatively, generate a sample recovery file using the following command and edit the resulting file to match your desired recovery configuration:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-shell",children:"$ gprecoverseg -o -p /home/gpadmin/recover_config_file\n"})}),"\n"]}),"\n",(0,s.jsxs)(n.li,{children:["\n",(0,s.jsx)(n.p,{children:"Run the following command, passing in the config file generated in the previous step:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-shell",children:"$ gprecoverseg -i recover_config_file\n"})}),"\n"]}),"\n",(0,s.jsxs)(n.li,{children:["\n",(0,s.jsxs)(n.p,{children:["Perform the post-recovery tasks summarized in the section ",(0,s.jsx)(n.a,{href:"#post-recovery-tasks",children:"Post-Recovery Tasks"}),"."]}),"\n"]}),"\n"]}),"\n",(0,s.jsx)(n.h3,{id:"recover-to-a-new-host-outside-of-the-cluster",children:"Recover to a new host, outside of the cluster"}),"\n",(0,s.jsx)(n.p,{children:"Follow these steps if you are planning to do a hardware refresh on the host the segments are running on."}),"\n",(0,s.jsx)(n.admonition,{type:"note",children:(0,s.jsx)(n.p,{children:"Only full recovery is possible when recovering to a new host."})}),"\n",(0,s.jsx)(n.h4,{id:"requirements-for-new-host",children:"Requirements for new host"}),"\n",(0,s.jsx)(n.p,{children:"The new host must:"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:["\n",(0,s.jsx)(n.p,{children:"have the same Apache Cloudberry software installed and configured as the failed host"}),"\n"]}),"\n",(0,s.jsxs)(n.li,{children:["\n",(0,s.jsx)(n.p,{children:"have the same hardware and OS configuration as the failed host (same hostname, OS version, OS configuration parameters applied, locales, gpadmin user account, data directory locations created, ssh keys exchanged, number of network interfaces, network interface naming convention, and so on)"}),"\n"]}),"\n",(0,s.jsxs)(n.li,{children:["\n",(0,s.jsx)(n.p,{children:"have sufficient disk space to accommodate the segments"}),"\n"]}),"\n",(0,s.jsxs)(n.li,{children:["\n",(0,s.jsx)(n.p,{children:"be able to connect password-less with all other existing segments and Cloudberry coordinator."}),"\n"]}),"\n"]}),"\n",(0,s.jsx)(n.h4,{id:"steps-to-recover-to-a-new-host",children:"Steps to recover to a new host"}),"\n",(0,s.jsxs)(n.ol,{children:["\n",(0,s.jsxs)(n.li,{children:["\n",(0,s.jsx)(n.p,{children:"Bring up the new host"}),"\n"]}),"\n",(0,s.jsxs)(n.li,{children:["\n",(0,s.jsx)(n.p,{children:"Run the following command to recover all segments to the new host:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-shell",children:"gprecoverseg -p <new_host_name>\n"})}),"\n",(0,s.jsx)(n.p,{children:"You may also specify more than one host. However, be sure you do not trigger a double-fault scenario when recovering to two hosts at a time."}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{children:"gprecoverseg -p <new_host_name1>,<new_host_name2>\n"})}),"\n",(0,s.jsx)(n.admonition,{type:"note",children:(0,s.jsx)(n.p,{children:"In the case of multiple failed segment hosts, you can specify the hosts to recover to with a comma-separated list. However, it is strongly recommended to recover to one host at a time. If you must recover to more than one host at a time, then it is critical to ensure that a double fault scenario does not occur, in which both the segment primary and corresponding mirror are offline."})}),"\n"]}),"\n",(0,s.jsxs)(n.li,{children:["\n",(0,s.jsxs)(n.p,{children:["Perform the post-recovery tasks summarized in the section ",(0,s.jsx)(n.a,{href:"#post-recovery-tasks",children:"Post-Recovery Tasks"}),"."]}),"\n"]}),"\n"]}),"\n",(0,s.jsx)(n.h3,{id:"post-recovery-tasks",children:"Post-recovery tasks"}),"\n",(0,s.jsxs)(n.p,{children:["Follow these steps once ",(0,s.jsx)(n.code,{children:"gprecoverseg"})," has completed:"]}),"\n",(0,s.jsxs)(n.ol,{children:["\n",(0,s.jsxs)(n.li,{children:["\n",(0,s.jsx)(n.p,{children:"Validate segement status and preferred roles:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-sql",children:"select * from gp_segment_configuration\n"})}),"\n"]}),"\n",(0,s.jsxs)(n.li,{children:["\n",(0,s.jsx)(n.p,{children:"Monitor mirror synchronization progress:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-shell",children:"gpstate -e\n"})}),"\n"]}),"\n",(0,s.jsxs)(n.li,{children:["\n",(0,s.jsx)(n.p,{children:"If necessary, run the following command to return segments to their preferred roles:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-shell",children:"gprecoverseg -r\n"})}),"\n"]}),"\n"]})]})}function h(e={}){const{wrapper:n}={...(0,i.a)(),...e.components};return n?(0,s.jsx)(n,{...e,children:(0,s.jsx)(d,{...e})}):d(e)}},11151:(e,n,r)=>{r.d(n,{Z:()=>l,a:()=>t});var s=r(67294);const i={},o=s.createContext(i);function t(e){const n=s.useContext(o);return s.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function l(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(i):e.components||i:t(e.components),s.createElement(o.Provider,{value:n},e.children)}}}]);