"use strict";(self.webpackChunkApache_Cloudberry_Incubating_website=self.webpackChunkApache_Cloudberry_Incubating_website||[]).push([[5076],{48383:(e,n,t)=>{t.r(n),t.d(n,{assets:()=>o,contentTitle:()=>i,default:()=>h,frontMatter:()=>r,metadata:()=>d,toc:()=>c});var s=t(85893),l=t(11151);const r={title:"Use PL/Python"},i="Use PL/Python",d={id:"developer/functions-and-procedures/use-pl-python",title:"Use PL/Python",description:"PL/Python is an embedded procedural language that allows you to write PostgreSQL functions using the Python programming language. Apache Cloudberry supports PL/Python using Python 3.",source:"@site/versioned_docs/version-2.x/developer/functions-and-procedures/use-pl-python.md",sourceDirName:"developer/functions-and-procedures",slug:"/developer/functions-and-procedures/use-pl-python",permalink:"/docs/developer/functions-and-procedures/use-pl-python",draft:!1,unlisted:!1,editUrl:"https://github.com/apache/cloudberry-site/edit/main/versioned_docs/version-2.x/developer/functions-and-procedures/use-pl-python.md",tags:[],version:"2.x",lastUpdatedBy:"TomShawn",lastUpdatedAt:1767860953,formattedLastUpdatedAt:"Jan 8, 2026",frontMatter:{title:"Use PL/Python"},sidebar:"docsbars",previous:{title:"Use PL/pgSQL",permalink:"/docs/developer/functions-and-procedures/use-pl-pgsql"},next:{title:"Use PL/R",permalink:"/docs/developer/functions-and-procedures/use-pl-r"}},o={},c=[{value:"Enable PL/Python",id:"enable-plpython",level:2},{value:"Write PL/Python functions",id:"write-plpython-functions",level:2},{value:"Arguments and results",id:"arguments-and-results",level:3},{value:"Data type mapping",id:"data-type-mapping",level:3},{value:"Built-in functions",id:"built-in-functions",level:2},{value:"Install Python modules",id:"install-python-modules",level:2}];function a(e){const n={admonition:"admonition",code:"code",h1:"h1",h2:"h2",h3:"h3",li:"li",ol:"ol",p:"p",pre:"pre",table:"table",tbody:"tbody",td:"td",th:"th",thead:"thead",tr:"tr",ul:"ul",...(0,l.a)(),...e.components};return(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)(n.h1,{id:"use-plpython",children:"Use PL/Python"}),"\n",(0,s.jsx)(n.p,{children:"PL/Python is an embedded procedural language that allows you to write PostgreSQL functions using the Python programming language. Apache Cloudberry supports PL/Python using Python 3."}),"\n",(0,s.jsx)(n.p,{children:"With PL/Python, you can:"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"Write functions in Python and call them from SQL."}),"\n",(0,s.jsx)(n.li,{children:"Use Python's extensive standard library and third-party modules."}),"\n",(0,s.jsxs)(n.li,{children:["Access the database via the ",(0,s.jsx)(n.code,{children:"plpy"})," module."]}),"\n"]}),"\n",(0,s.jsx)(n.h2,{id:"enable-plpython",children:"Enable PL/Python"}),"\n",(0,s.jsxs)(n.p,{children:["To use PL/Python, you must enable it in your database. Apache Cloudberry uses the untrusted ",(0,s.jsx)(n.code,{children:"plpython3u"})," language, which provides unrestricted access to the system."]}),"\n",(0,s.jsxs)(n.ol,{children:["\n",(0,s.jsxs)(n.li,{children:["\n",(0,s.jsxs)(n.p,{children:["Connect to your database using ",(0,s.jsx)(n.code,{children:"psql"}),"."]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-bash",children:"psql -d <database_name>\n"})}),"\n"]}),"\n",(0,s.jsxs)(n.li,{children:["\n",(0,s.jsxs)(n.p,{children:["Create the ",(0,s.jsx)(n.code,{children:"plpython3u"})," extension."]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-sql",children:"CREATE EXTENSION plpython3u;\n"})}),"\n",(0,s.jsx)(n.admonition,{type:"note",children:(0,s.jsxs)(n.p,{children:["Because PL/Python is an untrusted language (",(0,s.jsx)(n.code,{children:"u"})," suffix), only database superusers can creating functions using it. This is because it allows access to the file system and other system resources."]})}),"\n"]}),"\n"]}),"\n",(0,s.jsx)(n.h2,{id:"write-plpython-functions",children:"Write PL/Python functions"}),"\n",(0,s.jsxs)(n.p,{children:["You define a PL/Python function using the standard SQL ",(0,s.jsx)(n.code,{children:"CREATE FUNCTION"})," syntax. The body of the function is Python code."]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-sql",children:"CREATE FUNCTION py_max (a integer, b integer)\nRETURNS integer\nAS $$\n    if a > b:\n        return a\n    return b\n$$ LANGUAGE plpython3u;\n"})}),"\n",(0,s.jsx)(n.h3,{id:"arguments-and-results",children:"Arguments and results"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"Arguments are passed as variables matching the argument names."}),"\n",(0,s.jsxs)(n.li,{children:["You can also access arguments via the ",(0,s.jsx)(n.code,{children:"args"})," list."]}),"\n",(0,s.jsxs)(n.li,{children:["Return values are handled automatically. Python ",(0,s.jsx)(n.code,{children:"None"})," maps to SQL ",(0,s.jsx)(n.code,{children:"NULL"}),"."]}),"\n"]}),"\n",(0,s.jsx)(n.h3,{id:"data-type-mapping",children:"Data type mapping"}),"\n",(0,s.jsx)(n.p,{children:"Apache Cloudberry automatically maps SQL types to Python types."}),"\n",(0,s.jsxs)(n.table,{children:[(0,s.jsx)(n.thead,{children:(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.th,{style:{textAlign:"left"},children:"SQL type"}),(0,s.jsx)(n.th,{style:{textAlign:"left"},children:"Python type"})]})}),(0,s.jsxs)(n.tbody,{children:[(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{style:{textAlign:"left"},children:(0,s.jsx)(n.code,{children:"boolean"})}),(0,s.jsx)(n.td,{style:{textAlign:"left"},children:(0,s.jsx)(n.code,{children:"bool"})})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsxs)(n.td,{style:{textAlign:"left"},children:[(0,s.jsx)(n.code,{children:"integer"}),", ",(0,s.jsx)(n.code,{children:"bigint"})]}),(0,s.jsx)(n.td,{style:{textAlign:"left"},children:(0,s.jsx)(n.code,{children:"int"})})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsxs)(n.td,{style:{textAlign:"left"},children:[(0,s.jsx)(n.code,{children:"real"}),", ",(0,s.jsx)(n.code,{children:"double precision"})]}),(0,s.jsx)(n.td,{style:{textAlign:"left"},children:(0,s.jsx)(n.code,{children:"float"})})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsxs)(n.td,{style:{textAlign:"left"},children:[(0,s.jsx)(n.code,{children:"text"}),", ",(0,s.jsx)(n.code,{children:"varchar"})]}),(0,s.jsx)(n.td,{style:{textAlign:"left"},children:(0,s.jsx)(n.code,{children:"str"})})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{style:{textAlign:"left"},children:(0,s.jsx)(n.code,{children:"bytea"})}),(0,s.jsx)(n.td,{style:{textAlign:"left"},children:(0,s.jsx)(n.code,{children:"bytes"})})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{style:{textAlign:"left"},children:(0,s.jsx)(n.code,{children:"Array"})}),(0,s.jsx)(n.td,{style:{textAlign:"left"},children:(0,s.jsx)(n.code,{children:"list"})})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{style:{textAlign:"left"},children:(0,s.jsx)(n.code,{children:"Composite Type"})}),(0,s.jsxs)(n.td,{style:{textAlign:"left"},children:[(0,s.jsx)(n.code,{children:"dict"})," (for input), ",(0,s.jsx)(n.code,{children:"tuple"}),"/",(0,s.jsx)(n.code,{children:"dict"})," (for output)"]})]})]})]}),"\n",(0,s.jsx)(n.p,{children:"Example of returning a composite type:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-sql",children:"CREATE TYPE type_record AS (first text, second int4);\n\nCREATE FUNCTION return_composite()\nRETURNS type_record\nAS $$\n    return {'first': 'hello', 'second': 42}\n$$ LANGUAGE plpython3u;\n"})}),"\n",(0,s.jsx)(n.h2,{id:"built-in-functions",children:"Built-in functions"}),"\n",(0,s.jsxs)(n.p,{children:["The ",(0,s.jsx)(n.code,{children:"plpy"})," module provides methods to interact with the database."]}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"plpy.execute(query [, limit])"}),": Executes a SQL query."]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"plpy.prepare(query, argtypes)"}),": Prepares a query execution plan."]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"plpy.info(msg)"}),", ",(0,s.jsx)(n.code,{children:"plpy.error(msg)"}),": Logs messages."]}),"\n"]}),"\n",(0,s.jsxs)(n.p,{children:["Example using ",(0,s.jsx)(n.code,{children:"plpy.execute"}),":"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-sql",children:"CREATE FUNCTION get_user_name(id int)\nRETURNS text\nAS $$\n    res = plpy.execute(f\"SELECT username FROM users WHERE id = {id}\")\n    if res:\n        return res[0]['username']\n    return None\n$$ LANGUAGE plpython3u;\n"})}),"\n",(0,s.jsx)(n.h2,{id:"install-python-modules",children:"Install Python modules"}),"\n",(0,s.jsx)(n.p,{children:"You can use third-party Python modules in your PL/Python functions. The module must be installed on all hosts in the cluster (coordinator and segments)."}),"\n",(0,s.jsxs)(n.p,{children:["To install a module, use ",(0,s.jsx)(n.code,{children:"pip"})," on every host:"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-bash",children:'gpssh -f <hostfile> "pip3 install <module_name>"\n'})}),"\n",(0,s.jsx)(n.p,{children:"Then you can import it in your function:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-sql",children:"CREATE FUNCTION use_numpy()\nRETURNS float\nAS $$\n    import numpy as np\n    return np.mean([1, 2, 3, 4])\n$$ LANGUAGE plpython3u;\n"})})]})}function h(e={}){const{wrapper:n}={...(0,l.a)(),...e.components};return n?(0,s.jsx)(n,{...e,children:(0,s.jsx)(a,{...e})}):a(e)}},11151:(e,n,t)=>{t.d(n,{Z:()=>d,a:()=>i});var s=t(67294);const l={},r=s.createContext(l);function i(e){const n=s.useContext(r);return s.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function d(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(l):e.components||l:i(e.components),s.createElement(r.Provider,{value:n},e.children)}}}]);