"use strict";(self.webpackChunkApache_Cloudberry_Incubating_website=self.webpackChunkApache_Cloudberry_Incubating_website||[]).push([[91764],{14854:(e,n,i)=>{i.r(n),i.d(n,{assets:()=>l,contentTitle:()=>a,default:()=>p,frontMatter:()=>t,metadata:()=>o,toc:()=>c});var s=i(85893),r=i(11151);const t={title:"GPORCA Features and Enhancements"},a="GPORCA Features and Enhancements",o={id:"performance/optimize-queries/use-orca/orca-features",title:"GPORCA Features and Enhancements",description:"GPORCA provides enhanced support for certain types of queries and operations:",source:"@site/versioned_docs/version-2.x/performance/optimize-queries/use-orca/orca-features.md",sourceDirName:"performance/optimize-queries/use-orca",slug:"/performance/optimize-queries/use-orca/orca-features",permalink:"/docs/performance/optimize-queries/use-orca/orca-features",draft:!1,unlisted:!1,editUrl:"https://github.com/apache/cloudberry-site/edit/main/versioned_docs/version-2.x/performance/optimize-queries/use-orca/orca-features.md",tags:[],version:"2.x",lastUpdatedBy:"Dianjin Wang",lastUpdatedAt:1747907862,formattedLastUpdatedAt:"May 22, 2025",frontMatter:{title:"GPORCA Features and Enhancements"},sidebar:"docsbars",previous:{title:"GPORCA Overview",permalink:"/docs/performance/optimize-queries/use-orca/use-orca-overview"},next:{title:"GPORCA Optimizer Update Notes",permalink:"/docs/performance/optimize-queries/use-orca/whats-new-in-orca"}},l={},c=[{value:"Enhancements for partitioned table queries",id:"enhancements-for-partitioned-table-queries",level:2},{value:"Subquery optimization",id:"subquery-optimization",level:2},{value:"Common table expression (CTE) optimization",id:"common-table-expression-cte-optimization",level:2},{value:"DML operation optimization",id:"dml-operation-optimization",level:2},{value:"Other optimization capabilities",id:"other-optimization-capabilities",level:2}];function d(e){const n={admonition:"admonition",code:"code",h1:"h1",h2:"h2",li:"li",p:"p",pre:"pre",ul:"ul",...(0,r.a)(),...e.components};return(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)(n.h1,{id:"gporca-features-and-enhancements",children:"GPORCA Features and Enhancements"}),"\n",(0,s.jsx)(n.p,{children:"GPORCA provides enhanced support for certain types of queries and operations:"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"Queries on partitioned tables"}),"\n",(0,s.jsx)(n.li,{children:"Queries with subqueries"}),"\n",(0,s.jsx)(n.li,{children:"Queries with common table expressions (CTEs)"}),"\n",(0,s.jsx)(n.li,{children:"Optimized DML operations"}),"\n"]}),"\n",(0,s.jsx)(n.h2,{id:"enhancements-for-partitioned-table-queries",children:"Enhancements for partitioned table queries"}),"\n",(0,s.jsx)(n.p,{children:"GPORCA applies the following optimizations when handling queries on partitioned tables:"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:["\n",(0,s.jsx)(n.p,{children:"Improved partition pruning capabilities."}),"\n"]}),"\n",(0,s.jsxs)(n.li,{children:["\n",(0,s.jsx)(n.p,{children:"Query plans can include the Partition Selector operator."}),"\n"]}),"\n",(0,s.jsxs)(n.li,{children:["\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.code,{children:"EXPLAIN"})," plans no longer enumerate all partitions."]}),"\n",(0,s.jsxs)(n.p,{children:["For queries using static partition pruning (for example, comparing partition keys with constants), GPORCA displays a Partition Selector operator in the ",(0,s.jsx)(n.code,{children:"EXPLAIN"})," output, including the filter condition and the number of selected partitions. Example:"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-sql",children:"Partition Selector for Part_Table (dynamic scan id: 1) \n        Filter: a > 10\n        Partitions selected:  1 (out of 3)\n"})}),"\n",(0,s.jsxs)(n.p,{children:["For dynamic partition pruning (for example, comparing partition keys with variables), the partitions are determined at execution time, and the ",(0,s.jsx)(n.code,{children:"EXPLAIN"})," output does not list the selected partitions."]}),"\n"]}),"\n",(0,s.jsxs)(n.li,{children:["\n",(0,s.jsx)(n.p,{children:"The size of the query plan does not grow with the number of partitions."}),"\n"]}),"\n",(0,s.jsxs)(n.li,{children:["\n",(0,s.jsx)(n.p,{children:"Significantly reduces the risk of out-of-memory errors caused by a large number of partitions."}),"\n"]}),"\n"]}),"\n",(0,s.jsxs)(n.p,{children:["The following ",(0,s.jsx)(n.code,{children:"CREATE TABLE"})," example creates a range-partitioned table:"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-sql",children:"CREATE TABLE sales(order_id int, item_id int, amount numeric(15,2), \n      date date, yr_qtr int)\n   PARTITION BY RANGE (yr_qtr) (start (201501) INCLUSIVE end (201504) INCLUSIVE, \n   start (201601) INCLUSIVE end (201604) INCLUSIVE,\n   start (201701) INCLUSIVE end (201704) INCLUSIVE,     \n   start (201801) INCLUSIVE end (201804) INCLUSIVE,\n   start (201901) INCLUSIVE end (201904) INCLUSIVE,\n   start (202001) INCLUSIVE end (202004) INCLUSIVE);\n"})}),"\n",(0,s.jsx)(n.p,{children:"GPORCA optimizes the following types of queries on partitioned tables:"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:["\n",(0,s.jsx)(n.p,{children:"Full table scans: partitions are not enumerated in the plan."}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-sql",children:"SELECT * FROM sales;\n"})}),"\n"]}),"\n",(0,s.jsxs)(n.li,{children:["\n",(0,s.jsx)(n.p,{children:"Queries with constant filter conditions: partition pruning is applied."}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-sql",children:"SELECT * FROM sales WHERE yr_qtr = 201501;\n"})}),"\n"]}),"\n",(0,s.jsxs)(n.li,{children:["\n",(0,s.jsx)(n.p,{children:"Range queries: also trigger partition pruning."}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-sql",children:"SELECT * FROM sales WHERE yr_qtr BETWEEN 201601 AND 201704;\n"})}),"\n"]}),"\n",(0,s.jsxs)(n.li,{children:["\n",(0,s.jsxs)(n.p,{children:["Joins on partitioned tables: for example, joining the dimension table ",(0,s.jsx)(n.code,{children:"date_dim"})," with the fact table ",(0,s.jsx)(n.code,{children:"catalog_sales"}),"."]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-sql",children:"SELECT * FROM catalog_sales\n    WHERE date_id IN (SELECT id FROM date_dim WHERE month=12);\n"})}),"\n"]}),"\n"]}),"\n",(0,s.jsx)(n.h2,{id:"subquery-optimization",children:"Subquery optimization"}),"\n",(0,s.jsxs)(n.p,{children:["GPORCA processes subqueries more efficiently. A subquery is a query nested within an outer query block, such as the ",(0,s.jsx)(n.code,{children:"SELECT"})," inside the ",(0,s.jsx)(n.code,{children:"WHERE"})," clause below:"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-sql",children:"SELECT * FROM part\n  WHERE price > (SELECT avg(price) FROM part);\n"})}),"\n",(0,s.jsxs)(n.p,{children:["GPORCA also optimizes correlated subqueries (CSQs), which reference columns from the outer query. For example, both the inner and outer queries in the following statement use the ",(0,s.jsx)(n.code,{children:"price"})," column:"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-sql",children:"SELECT * FROM part p1 WHERE price > (SELECT avg(price) FROM part p2 WHERE p2.brand = p1.brand);\n"})}),"\n",(0,s.jsx)(n.p,{children:"GPORCA can generate more efficient plans for the following types of subqueries:"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:["\n",(0,s.jsxs)(n.p,{children:["Correlated subqueries in the ",(0,s.jsx)(n.code,{children:"SELECT"})," list:"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-sql",children:"SELECT *,\n(SELECT min(price) FROM part p2 WHERE p1.brand = p2.brand)\nAS foo\nFROM part p1;\n"})}),"\n"]}),"\n",(0,s.jsxs)(n.li,{children:["\n",(0,s.jsxs)(n.p,{children:["Correlated subqueries inside ",(0,s.jsx)(n.code,{children:"OR"})," conditions:"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-sql",children:"SELECT FROM part p1 WHERE p_size > 40 OR \n    p_retailprice > \n    (SELECT avg(p_retailprice) \n        FROM part p2 \n        WHERE p2.p_brand = p1.p_brand)\n"})}),"\n"]}),"\n",(0,s.jsxs)(n.li,{children:["\n",(0,s.jsx)(n.p,{children:"Nested subqueries with jump correlations:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-sql",children:"SELECT * FROM part p1 WHERE p1.p_partkey \nIN (SELECT p_partkey FROM part p2 WHERE p2.p_retailprice = \n    (SELECT min(p_retailprice)\n        FROM part p3 \n        WHERE p3.p_brand = p1.p_brand)\n);\n"})}),"\n",(0,s.jsx)(n.admonition,{type:"info",children:(0,s.jsx)(n.p,{children:"The PostgreSQL planner does not support nested correlated subqueries with jump correlations."})}),"\n"]}),"\n",(0,s.jsxs)(n.li,{children:["\n",(0,s.jsx)(n.p,{children:"Correlated subqueries with aggregation and inequality:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-sql",children:"SELECT * FROM part p1 WHERE p1.p_retailprice =\n(SELECT min(p_retailprice) FROM part p2 WHERE p2.p_brand <> p1.p_brand);\n"})}),"\n"]}),"\n",(0,s.jsxs)(n.li,{children:["\n",(0,s.jsx)(n.p,{children:"Correlated subqueries expected to return a single row:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-sql",children:"SELECT p_partkey, \n(SELECT p_retailprice FROM part p2 WHERE p2.p_brand = p1.p_brand )\nFROM part p1;\n"})}),"\n"]}),"\n"]}),"\n",(0,s.jsx)(n.h2,{id:"common-table-expression-cte-optimization",children:"Common table expression (CTE) optimization"}),"\n",(0,s.jsxs)(n.p,{children:["GPORCA efficiently handles queries with ",(0,s.jsx)(n.code,{children:"WITH"})," clauses. A ",(0,s.jsx)(n.code,{children:"WITH"})," clause, also known as a common table expression (CTE), defines a temporary logical table used within the query. The following is an example of a query with a CTE:"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-sql",children:"WITH v AS (SELECT a, sum(b) as s FROM T WHERE c < 10 GROUP BY a)\n  SELECT * FROM  v AS v1, v AS v2\n  WHERE v1.a <> v2.a AND v1.s < v2.s;\n"})}),"\n",(0,s.jsx)(n.p,{children:"As part of query optimization, GPORCA supports predicate pushdown into CTEs. In the example below, equality predicates are pushed into the CTE:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-sql",children:"WITH v AS (SELECT a, sum(b) as s FROM T GROUP BY a)\n  SELECT *\n  FROM v as v1, v as v2, v as v3\n  WHERE v1.a < v2.a\n    AND v1.s < v3.s\n    AND v1.a = 10\n    AND v2.a = 20\n    AND v3.a = 30;\n"})}),"\n",(0,s.jsx)(n.p,{children:"GPORCA supports the following types of CTEs:"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:["\n",(0,s.jsx)(n.p,{children:"CTEs that define multiple logical tables. In the example below, the CTE defines two logical tables:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-sql",children:"WITH cte1 AS (SELECT a, sum(b) as s FROM T \n               WHERE c < 10 GROUP BY a),\n      cte2 AS (SELECT a, s FROM cte1 WHERE s > 1000)\n  SELECT *\n  FROM cte1 as v1, cte2 as v2, cte2 as v3\n  WHERE v1.a < v2.a AND v1.s < v3.s;\n"})}),"\n"]}),"\n"]}),"\n",(0,s.jsx)(n.h2,{id:"dml-operation-optimization",children:"DML operation optimization"}),"\n",(0,s.jsxs)(n.p,{children:["GPORCA also enhances DML operations such as ",(0,s.jsx)(n.code,{children:"INSERT"}),", ",(0,s.jsx)(n.code,{children:"UPDATE"}),", and ",(0,s.jsx)(n.code,{children:"DELETE"}),":"]}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:["\n",(0,s.jsx)(n.p,{children:"DML operations appear as regular operator nodes in the execution plan."}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"They can appear at any position in the plan (currently limited to the top-level slice)."}),"\n",(0,s.jsx)(n.li,{children:"They can have downstream nodes (consumers)."}),"\n"]}),"\n"]}),"\n",(0,s.jsxs)(n.li,{children:["\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.code,{children:"UPDATE"})," operations are implemented using the ",(0,s.jsx)(n.code,{children:"Split"})," operator and support the following:"]}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"Updates to distribution key columns."}),"\n",(0,s.jsxs)(n.li,{children:["Updates to partition key columns. The following example shows a plan containing a ",(0,s.jsx)(n.code,{children:"Split"})," operator:"]}),"\n"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-sql",children:"QUERY PLAN\n--------------------------------------------------------------\nUpdate  (cost=0.00..5.46 rows=1 width=1)\n   ->  Redistribute Motion 2:2  (slice1; segments: 2)\n         Hash Key: a\n         ->  Result  (cost=0.00..3.23 rows=1 width=48)\n               ->  Split  (cost=0.00..2.13 rows=1 width=40)\n                     ->  Result  (cost=0.00..1.05 rows=1 width=40)\n                           ->  Seq Scan on dmltest\n"})}),"\n"]}),"\n"]}),"\n",(0,s.jsx)(n.h2,{id:"other-optimization-capabilities",children:"Other optimization capabilities"}),"\n",(0,s.jsx)(n.p,{children:"GPORCA also includes the following optimization features:"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"Improved join order selection."}),"\n",(0,s.jsx)(n.li,{children:"Support for reordering joins and aggregation operations."}),"\n",(0,s.jsx)(n.li,{children:"Optimization of sort order."}),"\n",(0,s.jsx)(n.li,{children:"Consideration of data skew estimation during optimization."}),"\n"]})]})}function p(e={}){const{wrapper:n}={...(0,r.a)(),...e.components};return n?(0,s.jsx)(n,{...e,children:(0,s.jsx)(d,{...e})}):d(e)}},11151:(e,n,i)=>{i.d(n,{Z:()=>o,a:()=>a});var s=i(67294);const r={},t=s.createContext(r);function a(e){const n=s.useContext(t);return s.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function o(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(r):e.components||r:a(e.components),s.createElement(t.Provider,{value:n},e.children)}}}]);