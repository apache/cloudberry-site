"use strict";(self.webpackChunkApache_Cloudberry_Incubating_website=self.webpackChunkApache_Cloudberry_Incubating_website||[]).push([[88533],{4631:(e,r,i)=>{i.r(r),i.d(r,{assets:()=>m,contentTitle:()=>a,default:()=>d,frontMatter:()=>s,metadata:()=>o,toc:()=>c});var t=i(85893),n=i(11151);const s={title:"Segment Mirroring Overview"},a="Segment Mirroring Overview",o={id:"sys-admin/high-availability/segment-mirroring-overview",title:"Segment Mirroring Overview",description:"When Apache Cloudberry High Availability is enabled, there are two types of segment instances: primary and mirror. Each primary segment has one corresponding mirror segment. A primary segment instance receives requests from the coordinator to make changes to the segment data and then replicates those changes to the corresponding mirror. If Apache Cloudberry detects that a primary segment has failed or become unavailable, it changes the role of its mirror segment to primary segment and the role of the unavailable primary segment to mirror segment. Transactions in progress when the failure occurred roll back and must be restarted. The administrator must then recover the mirror segment, allow the mirror to synchronize with the current primary segment, and then exchange the primary and mirror segments so they are in their preferred roles.",source:"@site/versioned_docs/version-2.x/sys-admin/high-availability/segment-mirroring-overview.md",sourceDirName:"sys-admin/high-availability",slug:"/sys-admin/high-availability/segment-mirroring-overview",permalink:"/docs/sys-admin/high-availability/segment-mirroring-overview",draft:!1,unlisted:!1,editUrl:"https://github.com/apache/cloudberry-site/edit/main/versioned_docs/version-2.x/sys-admin/high-availability/segment-mirroring-overview.md",tags:[],version:"2.x",lastUpdatedBy:"TomShawn",lastUpdatedAt:1761905913,formattedLastUpdatedAt:"Oct 31, 2025",frontMatter:{title:"Segment Mirroring Overview"},sidebar:"docsbars",previous:{title:"High Availability Overview",permalink:"/docs/sys-admin/high-availability/high-availability-overview"},next:{title:"Coordinator Mirroring Overview",permalink:"/docs/sys-admin/high-availability/coordinator-mirroring-overview"}},m={},c=[{value:"About segment mirroring configurations",id:"about-segment-mirroring-configurations",level:2}];function h(e){const r={a:"a",admonition:"admonition",code:"code",em:"em",h1:"h1",h2:"h2",img:"img",li:"li",p:"p",ul:"ul",...(0,n.a)(),...e.components};return(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)(r.h1,{id:"segment-mirroring-overview",children:"Segment Mirroring Overview"}),"\n",(0,t.jsxs)(r.p,{children:["When Apache Cloudberry High Availability is enabled, there are two types of segment instances: ",(0,t.jsx)(r.em,{children:"primary"})," and ",(0,t.jsx)(r.em,{children:"mirror"}),". Each primary segment has one corresponding mirror segment. A primary segment instance receives requests from the coordinator to make changes to the segment data and then replicates those changes to the corresponding mirror. If Apache Cloudberry detects that a primary segment has failed or become unavailable, it changes the role of its mirror segment to primary segment and the role of the unavailable primary segment to mirror segment. Transactions in progress when the failure occurred roll back and must be restarted. The administrator must then recover the mirror segment, allow the mirror to synchronize with the current primary segment, and then exchange the primary and mirror segments so they are in their preferred roles."]}),"\n",(0,t.jsx)(r.p,{children:"If segment mirroring is not enabled, the Apache Cloudberry system shuts down if a segment instance fails. Administrators must manually recover all failed segments before Apache Cloudberry operations can resume."}),"\n",(0,t.jsxs)(r.p,{children:["When segment mirroring is enabled for an existing system, the primary segment instances continue to provide service to users while a snapshot of the primary segments are taken. While the snapshots are taken and deployed on the mirror segment instances, changes to the primary segment are also recorded. After the snapshot has been deployed on the mirror segment, the mirror segment is synchronized and kept current using Write-Ahead Logging (WAL)-based streaming replication. Apache Cloudberry WAL replication uses the ",(0,t.jsx)(r.code,{children:"walsender"})," and ",(0,t.jsx)(r.code,{children:"walreceiver"})," replication processes. The ",(0,t.jsx)(r.code,{children:"walsender"})," process is a primary segment process. The ",(0,t.jsx)(r.code,{children:"walreceiver"})," is a mirror segment process."]}),"\n",(0,t.jsx)(r.p,{children:"When database changes occur, the logs that capture the changes are streamed to the mirror segment to keep it current with the corresponding primary segments. During WAL replication, database changes are written to the logs before being applied, to ensure data integrity for any in-process operations."}),"\n",(0,t.jsxs)(r.p,{children:["When Apache Cloudberry detects a primary segment failure, the WAL replication process stops and the mirror segment automatically starts as the active primary segment. If a mirror segment fails or becomes inaccessible while the primary is active, the primary segment tracks database changes in logs that are applied to the mirror when it is recovered. For information about segment fault detection and the recovery process, see ",(0,t.jsx)(r.a,{href:"/docs/sys-admin/high-availability/detect-a-failed-segment",children:"How Apache Cloudberry Detects a Failed Segment"})," and ",(0,t.jsx)(r.a,{href:"/docs/sys-admin/high-availability/recover-from-segment-failures",children:"Recovering from Segment Failures"}),"."]}),"\n",(0,t.jsx)(r.p,{children:"These Apache Cloudberry system catalog tables contain mirroring and replication information."}),"\n",(0,t.jsxs)(r.ul,{children:["\n",(0,t.jsxs)(r.li,{children:["The catalog table ",(0,t.jsx)(r.a,{href:"/docs/sys-catalogs/sys-tables/gp-segment-configuration",children:(0,t.jsx)(r.code,{children:"gp_segment_configuration"})})," contains the current configuration and state of primary and mirror segment instances and the coordinator and standby coordinator instance."]}),"\n",(0,t.jsxs)(r.li,{children:["The catalog view gp_stat_replication contains replication statistics of the ",(0,t.jsx)(r.code,{children:"walsender"})," processes that are used for Apache Cloudberry coordinator and segment mirroring."]}),"\n"]}),"\n",(0,t.jsx)(r.h2,{id:"about-segment-mirroring-configurations",children:"About segment mirroring configurations"}),"\n",(0,t.jsxs)(r.p,{children:["Mirror segment instances can be placed on hosts in the cluster in different configurations. As a best practice, a primary segment and the corresponding mirror are placed on different hosts. Each host must have the same number of primary and mirror segments. When you create segment mirrors with the Apache Cloudberry utilities ",(0,t.jsx)(r.a,{href:"/docs/sys-utilities/gpinitsystem",children:(0,t.jsx)(r.code,{children:"gpinitsystem"})})," or ",(0,t.jsx)(r.a,{href:"/docs/sys-utilities/gpaddmirrors",children:(0,t.jsx)(r.code,{children:"gpaddmirrors"})})," you can specify the segment mirror configuration, group mirroring (the default) or spread mirroring. With ",(0,t.jsx)(r.code,{children:"gpaddmirrors"}),", you can create custom mirroring configurations with a ",(0,t.jsx)(r.code,{children:"gpaddmirrors"})," configuration file and specify the file on the command line."]}),"\n",(0,t.jsxs)(r.p,{children:[(0,t.jsx)(r.em,{children:"Group mirroring"})," is the default mirroring configuration when you enable mirroring during system initialization. The mirror segments for each host's primary segments are placed on one other host. If a single host fails, the number of active primary segments doubles on the host that backs the failed host. The following figure illustrates a group mirroring configuration."]}),"\n",(0,t.jsx)(r.p,{children:(0,t.jsx)(r.img,{alt:"Group Segment Mirroring in Apache Cloudberry",src:i(3235).Z+"",width:"464",height:"432"})}),"\n",(0,t.jsxs)(r.p,{children:[(0,t.jsx)(r.em,{children:"Spread mirroring"})," can be specified during system initialization. This configuration spreads each host's mirrors over multiple hosts so that if any single host fails, no other host will have more than one mirror promoted to an active primary segment. Spread mirroring is possible only if there are more hosts than segments per host. The following figure illustrates the placement of mirrors in a spread segment mirroring configuration."]}),"\n",(0,t.jsx)(r.p,{children:(0,t.jsx)(r.img,{alt:"Spread Segment Mirroring in Apache Cloudberry",src:i(33500).Z+"",width:"504",height:"309"})}),"\n",(0,t.jsx)(r.admonition,{type:"note",children:(0,t.jsxs)(r.p,{children:["You must ensure you have the appropriate number of host systems for your mirroring configuration when you create a system or when you expand a system. For example, to create a system that is configured with spread mirroring requires more hosts than segment instances per host, and a system that is configured with group mirroring requires at least two new hosts when expanding the system. For information about segment mirroring configurations, see ",(0,t.jsx)(r.a,{href:"/docs/tutorials/best-practices/high-availability-best-practices#configure-segment-mirroring",children:"Segment Mirroring Configurations"}),". For information about expanding systems with segment mirroring enabled, see ",(0,t.jsx)(r.a,{href:"/docs/sys-admin/expand-cluster/plan-system-expansion",children:"Planning Mirror Segments"}),"."]})})]})}function d(e={}){const{wrapper:r}={...(0,n.a)(),...e.components};return r?(0,t.jsx)(r,{...e,children:(0,t.jsx)(h,{...e})}):h(e)}},3235:(e,r,i)=>{i.d(r,{Z:()=>t});const t=i.p+"assets/images/group-mirroring-9b0f633d6000f2ac466c7c8948081629.png"},33500:(e,r,i)=>{i.d(r,{Z:()=>t});const t=i.p+"assets/images/spread-mirroring-90a2eb35b9236f5966a422a7c1f9d2ec.png"},11151:(e,r,i)=>{i.d(r,{Z:()=>o,a:()=>a});var t=i(67294);const n={},s=t.createContext(n);function a(e){const r=t.useContext(s);return t.useMemo((function(){return"function"==typeof e?e(r):{...r,...e}}),[r,e])}function o(e){let r;return r=e.disableParentContext?"function"==typeof e.components?e.components(n):e.components||n:a(e.components),t.createElement(s.Provider,{value:r},e.children)}}}]);