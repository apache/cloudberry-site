"use strict";(self.webpackChunkApache_Cloudberry_Incubating_website=self.webpackChunkApache_Cloudberry_Incubating_website||[]).push([[39969],{87871:(e,r,s)=>{s.r(r),s.d(r,{assets:()=>o,contentTitle:()=>a,default:()=>d,frontMatter:()=>i,metadata:()=>l,toc:()=>u});var t=s(85893),n=s(11151);const i={title:"Subqueries"},a="Subqueries",l={id:"operate-with-data/sql-queries/subqueries",title:"Subqueries",description:"Subqueries let you embed one query inside another, enabling dynamic and conditional logic when defining queries. They are useful for filtering, calculating intermediate values, or expressing correlated relationships.",source:"@site/versioned_docs/version-2.x/operate-with-data/sql-queries/subqueries.md",sourceDirName:"operate-with-data/sql-queries",slug:"/operate-with-data/sql-queries/subqueries",permalink:"/docs/operate-with-data/sql-queries/subqueries",draft:!1,unlisted:!1,editUrl:"https://github.com/apache/cloudberry-site/edit/main/versioned_docs/version-2.x/operate-with-data/sql-queries/subqueries.md",tags:[],version:"2.x",lastUpdatedBy:"Dianjin Wang",lastUpdatedAt:1753946932,formattedLastUpdatedAt:"Jul 31, 2025",frontMatter:{title:"Subqueries"},sidebar:"docsbars",previous:{title:"Queries with Aggregate Expressions",permalink:"/docs/operate-with-data/sql-queries/aggregates-expressions"},next:{title:"Common Table Expressions",permalink:"/docs/operate-with-data/sql-queries/cte-queries"}},o={},u=[{value:"Correlated subqueries",id:"correlated-subqueries",level:2},{value:"Correlated subquery examples",id:"correlated-subquery-examples",level:2},{value:"Example 1 \u2013 Scalar correlated subquery",id:"example-1--scalar-correlated-subquery",level:3},{value:"Example 2 \u2013 Correlated EXISTS subquery",id:"example-2--correlated-exists-subquery",level:3},{value:"Example 3 - CSQ in the select list",id:"example-3---csq-in-the-select-list",level:3},{value:"Example 4 - CSQs connected by OR clauses",id:"example-4---csqs-connected-by-or-clauses",level:3}];function c(e){const r={a:"a",code:"code",em:"em",h1:"h1",h2:"h2",h3:"h3",li:"li",p:"p",pre:"pre",ul:"ul",...(0,n.a)(),...e.components};return(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)(r.h1,{id:"subqueries",children:"Subqueries"}),"\n",(0,t.jsx)(r.p,{children:"Subqueries let you embed one query inside another, enabling dynamic and conditional logic when defining queries. They are useful for filtering, calculating intermediate values, or expressing correlated relationships."}),"\n",(0,t.jsx)(r.p,{children:"This document distinguishes between scalar and correlated subqueries and provides guidance on when and how to use them effectively."}),"\n",(0,t.jsxs)(r.p,{children:["A scalar subquery is a ",(0,t.jsx)(r.code,{children:"SELECT"})," query in parentheses that returns exactly one row with one column. Do not use a ",(0,t.jsx)(r.code,{children:"SELECT"})," query that returns multiple rows or columns as a scalar subquery. The query runs and uses the returned value in the surrounding value expression. A correlated scalar subquery contains references to the outer query block."]}),"\n",(0,t.jsx)(r.h2,{id:"correlated-subqueries",children:"Correlated subqueries"}),"\n",(0,t.jsxs)(r.p,{children:["A correlated subquery (CSQ) is a ",(0,t.jsx)(r.code,{children:"SELECT"})," query with a ",(0,t.jsx)(r.code,{children:"WHERE"})," clause or target list that contains references to the parent outer clause. CSQs efficiently express results in terms of results of another query. Apache Cloudberry supports correlated subqueries that provide compatibility with many existing applications. A CSQ is a scalar or table subquery, depending on whether it returns one or multiple rows. Apache Cloudberry does not support correlated subqueries with skip-level correlations."]}),"\n",(0,t.jsx)(r.h2,{id:"correlated-subquery-examples",children:"Correlated subquery examples"}),"\n",(0,t.jsx)(r.h3,{id:"example-1--scalar-correlated-subquery",children:"Example 1 \u2013 Scalar correlated subquery"}),"\n",(0,t.jsx)(r.pre,{children:(0,t.jsx)(r.code,{className:"language-sql",children:"SELECT * FROM t1 WHERE t1.x \n\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0> (SELECT MAX(t2.x) FROM t2 WHERE t2.y = t1.y);\n"})}),"\n",(0,t.jsx)(r.h3,{id:"example-2--correlated-exists-subquery",children:"Example 2 \u2013 Correlated EXISTS subquery"}),"\n",(0,t.jsx)(r.pre,{children:(0,t.jsx)(r.code,{className:"language-sql",children:"SELECT * FROM t1 WHERE \nEXISTS (SELECT 1 FROM t2 WHERE t2.x = t1.x);\n"})}),"\n",(0,t.jsx)(r.p,{children:"Apache Cloudberry uses one of the following methods to run CSQs:"}),"\n",(0,t.jsxs)(r.ul,{children:["\n",(0,t.jsx)(r.li,{children:"Unnest the CSQ into join operations \u2013 This method is most efficient, and it is how Apache Cloudberry runs most CSQs, including queries from the TPC-H benchmark."}),"\n",(0,t.jsxs)(r.li,{children:["Run the CSQ on every row of the outer query \u2013 This method is relatively inefficient, and it is how Apache Cloudberry runs queries that contain CSQs in the ",(0,t.jsx)(r.code,{children:"SELECT"})," list or are connected by ",(0,t.jsx)(r.code,{children:"OR"})," conditions."]}),"\n"]}),"\n",(0,t.jsx)(r.p,{children:"The following examples illustrate how to rewrite some of these types of queries to improve performance."}),"\n",(0,t.jsx)(r.h3,{id:"example-3---csq-in-the-select-list",children:"Example 3 - CSQ in the select list"}),"\n",(0,t.jsx)(r.p,{children:(0,t.jsx)(r.em,{children:"Original Query"})}),"\n",(0,t.jsx)(r.pre,{children:(0,t.jsx)(r.code,{className:"language-sql",children:"SELECT T1.a,\n\xa0\xa0\xa0\xa0\xa0\xa0(SELECT COUNT(DISTINCT T2.z) FROM t2 WHERE t1.x = t2.y) dt2 \nFROM t1;\n"})}),"\n",(0,t.jsxs)(r.p,{children:["Rewrite this query to perform an inner join with ",(0,t.jsx)(r.code,{children:"t1"})," first and then perform a left join with ",(0,t.jsx)(r.code,{children:"t1"})," again. The rewrite applies for only an equijoin in the correlated condition."]}),"\n",(0,t.jsx)(r.p,{children:(0,t.jsx)(r.em,{children:"Rewritten Query"})}),"\n",(0,t.jsx)(r.pre,{children:(0,t.jsx)(r.code,{className:"language-sql",children:"SELECT t1.a, dt2 FROM t1 \n\xa0\xa0\xa0\xa0\xa0\xa0\xa0LEFT JOIN \n\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0(SELECT t2.y AS csq_y, COUNT(DISTINCT t2.z) AS dt2 \n\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0FROM t1, t2 WHERE t1.x = t2.y \n              GROUP BY t1.x) \n\xa0\xa0\xa0\xa0\xa0\xa0\xa0ON (t1.x = csq_y);\n"})}),"\n",(0,t.jsx)(r.h3,{id:"example-4---csqs-connected-by-or-clauses",children:"Example 4 - CSQs connected by OR clauses"}),"\n",(0,t.jsx)(r.p,{children:(0,t.jsx)(r.em,{children:"Original Query"})}),"\n",(0,t.jsx)(r.pre,{children:(0,t.jsx)(r.code,{className:"language-sql",children:"SELECT * FROM t1 \nWHERE \nx > (SELECT COUNT(*) FROM t2 WHERE t1.x = t2.x) \nOR x < (SELECT COUNT(*) FROM t3 WHERE t1.y = t3.y)\n"})}),"\n",(0,t.jsxs)(r.p,{children:["Rewrite this query to separate it into two parts with a union on the ",(0,t.jsx)(r.code,{children:"OR"})," conditions."]}),"\n",(0,t.jsx)(r.p,{children:(0,t.jsx)(r.em,{children:"Rewritten Query"})}),"\n",(0,t.jsx)(r.pre,{children:(0,t.jsx)(r.code,{className:"language-sql",children:"SELECT * FROM t1 \nWHERE x > (SELECT count(*) FROM t2 WHERE t1.x = t2.x) \nUNION \nSELECT * FROM t1 \nWHERE x < (SELECT count(*) FROM t3 WHERE t1.y = t3.y)\n"})}),"\n",(0,t.jsxs)(r.p,{children:["To view the query plan, use ",(0,t.jsx)(r.code,{children:"EXPLAIN SELECT"})," or ",(0,t.jsx)(r.code,{children:"EXPLAIN ANALYZE SELECT"}),". Subplan nodes in the query plan indicate that the query will run on every row of the outer query, and the query is a candidate for rewriting. For more information about these statements, see ",(0,t.jsx)(r.a,{href:"/docs/performance/optimize-queries/analyze-query-performance",children:"Analyze Query Performance"}),"."]})]})}function d(e={}){const{wrapper:r}={...(0,n.a)(),...e.components};return r?(0,t.jsx)(r,{...e,children:(0,t.jsx)(c,{...e})}):c(e)}},11151:(e,r,s)=>{s.d(r,{Z:()=>l,a:()=>a});var t=s(67294);const n={},i=t.createContext(n);function a(e){const r=t.useContext(i);return t.useMemo((function(){return"function"==typeof e?e(r):{...r,...e}}),[r,e])}function l(e){let r;return r=e.disableParentContext?"function"==typeof e.components?e.components(n):e.components||n:a(e.components),t.createElement(i.Provider,{value:r},e.children)}}}]);